<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deep Dive: Security & Authentication - IHSS/CMIPS</title>
    <style>
        :root {
            --primary: #1a1a2e;
            --secondary: #16213e;
            --accent: #4a0e4e;
            --accent-light: #9c27b0;
            --highlight: #e040fb;
            --success: #00e676;
            --warning: #ffab00;
            --danger: #ff1744;
            --text: #f0f0f0;
            --text-muted: #b0b0b0;
            --code-bg: #0d0d1a;
            --border: #3d3d5c;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--primary);
            color: var(--text);
            line-height: 1.7;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, var(--accent) 0%, var(--secondary) 100%);
            padding: 4rem 2rem;
            text-align: center;
            border-bottom: 3px solid var(--highlight);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(224, 64, 251, 0.1) 0%, transparent 70%);
            animation: pulse 15s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .header h1 {
            font-size: 2.75rem;
            font-weight: 700;
            position: relative;
            z-index: 1;
        }

        .header h1 span { color: var(--highlight); }

        .header p { color: var(--text-muted); font-size: 1.1rem; position: relative; z-index: 1; }

        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }

        .section {
            background: var(--secondary);
            border-radius: 16px;
            padding: 2.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border);
        }

        .section h2 {
            color: var(--highlight);
            font-size: 1.75rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--highlight);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .section h3 { color: var(--text); font-size: 1.25rem; margin: 1.5rem 0 1rem; }
        .section h4 { color: var(--accent-light); font-size: 1.1rem; margin: 1rem 0 0.75rem; }

        .code-block {
            background: var(--code-bg);
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1rem 0;
            overflow-x: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            border: 1px solid var(--border);
            line-height: 1.6;
        }

        .code-block .comment { color: #6a9955; }
        .code-block .keyword { color: #c586c0; }
        .code-block .string { color: #ce9178; }
        .code-block .function { color: #dcdcaa; }
        .code-block .annotation { color: #569cd6; }
        .code-block .type { color: #4ec9b0; }
        .code-block .number { color: #b5cea8; }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border: 1px solid var(--border);
        }

        th {
            background: rgba(224, 64, 251, 0.2);
            color: var(--highlight);
            font-weight: 600;
        }

        tr:nth-child(even) { background: rgba(255, 255, 255, 0.02); }

        .highlight-box {
            background: linear-gradient(135deg, rgba(224, 64, 251, 0.1) 0%, rgba(224, 64, 251, 0.05) 100%);
            border-left: 4px solid var(--highlight);
            padding: 1.5rem;
            border-radius: 0 8px 8px 0;
            margin: 1rem 0;
        }

        .success-box {
            background: linear-gradient(135deg, rgba(0, 230, 118, 0.1) 0%, rgba(0, 230, 118, 0.05) 100%);
            border-left: 4px solid var(--success);
            padding: 1.5rem;
            border-radius: 0 8px 8px 0;
            margin: 1rem 0;
        }

        .warning-box {
            background: linear-gradient(135deg, rgba(255, 171, 0, 0.1) 0%, rgba(255, 171, 0, 0.05) 100%);
            border-left: 4px solid var(--warning);
            padding: 1.5rem;
            border-radius: 0 8px 8px 0;
            margin: 1rem 0;
        }

        .danger-box {
            background: linear-gradient(135deg, rgba(255, 23, 68, 0.1) 0%, rgba(255, 23, 68, 0.05) 100%);
            border-left: 4px solid var(--danger);
            padding: 1.5rem;
            border-radius: 0 8px 8px 0;
            margin: 1rem 0;
        }

        ul, ol { margin-left: 1.5rem; margin-bottom: 1rem; }
        li { margin-bottom: 0.5rem; }

        .role-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin: 1.5rem 0;
        }

        .role-card {
            background: linear-gradient(135deg, rgba(74, 14, 78, 0.3) 0%, rgba(22, 33, 62, 0.5) 100%);
            border: 1px solid var(--accent-light);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .role-card h4 {
            color: var(--highlight);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .role-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 0.5rem;
        }

        .badge-elevated { background: var(--highlight); color: var(--primary); }
        .badge-staff { background: var(--success); color: var(--primary); }
        .badge-external { background: var(--warning); color: var(--primary); }

        .auth-flow {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .auth-step {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .auth-step-num {
            width: 40px;
            height: 40px;
            background: var(--highlight);
            color: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
        }

        .auth-step-content {
            flex-grow: 1;
        }

        .auth-step-title {
            font-weight: 600;
            color: var(--highlight);
            margin-bottom: 0.25rem;
        }

        .auth-step-desc {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .jwt-structure {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .jwt-part {
            background: var(--code-bg);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
        }

        .jwt-part-name {
            font-weight: 600;
            color: var(--highlight);
            margin-bottom: 0.5rem;
        }

        .jwt-part-color {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            word-break: break-all;
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }

        .jwt-header { background: rgba(255, 0, 0, 0.2); color: #ff6b6b; }
        .jwt-payload { background: rgba(138, 43, 226, 0.2); color: #b06bff; }
        .jwt-signature { background: rgba(0, 128, 255, 0.2); color: #6bb3ff; }

        .security-layer {
            border-left: 3px solid var(--highlight);
            padding-left: 1.5rem;
            margin: 1rem 0;
        }

        .security-layer h5 {
            color: var(--accent-light);
            margin-bottom: 0.5rem;
        }

        .config-table {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
        }

        .config-table td:first-child {
            color: var(--highlight);
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîê Security & <span>Authentication</span> Deep Dive</h1>
        <p>Complete Implementation Guide for JWT Authentication, RBAC, and County-Level Data Isolation</p>
    </div>

    <div class="container">
        <!-- Overview -->
        <section class="section">
            <h2>üéØ Security Architecture Overview</h2>
            
            <p>The IHSS/CMIPS system implements a comprehensive security model using Keycloak as the identity provider, JWT tokens for stateless authentication, and role-based access control (RBAC) with county-level data isolation.</p>

            <h3>Security Layers</h3>
            <div class="security-layer">
                <h5>Layer 1: Authentication (Keycloak + JWT)</h5>
                <p>All users must authenticate through Keycloak. The system validates JWT tokens on every request and extracts user identity, roles, and county claims.</p>
            </div>
            <div class="security-layer">
                <h5>Layer 2: Authorization (RBAC)</h5>
                <p>Six canonical roles (ADMIN, SUPERVISOR, CASE_WORKER, PROVIDER, RECIPIENT, SYSTEM_SCHEDULER) with different permission levels determine what actions users can perform.</p>
            </div>
            <div class="security-layer">
                <h5>Layer 3: Data Isolation (County Filter)</h5>
                <p>Users with restricted roles (CASE_WORKER, PROVIDER, RECIPIENT) can only access data from their assigned county, extracted from the JWT token.</p>
            </div>
            <div class="security-layer">
                <h5>Layer 4: Field Masking (Role-Based)</h5>
                <p>Sensitive fields are masked based on the user's role. Different roles see different levels of detail for the same data.</p>
            </div>
        </section>

        <!-- User Roles -->
        <section class="section">
            <h2>üë• User Roles & Permissions</h2>

            <div class="role-grid">
                <div class="role-card">
                    <h4>ADMIN</h4>
                    <span class="role-badge badge-elevated">Elevated</span>
                    <span class="role-badge badge-staff">Internal Staff</span>
                    <ul style="margin-top: 1rem;">
                        <li>Full access to all data across all counties</li>
                        <li>Can view unmasked sensitive fields</li>
                        <li>Can configure field masking rules</li>
                        <li>Can manage scheduled reports</li>
                        <li>Can access all analytics endpoints</li>
                    </ul>
                </div>
                <div class="role-card">
                    <h4>SUPERVISOR</h4>
                    <span class="role-badge badge-staff">Internal Staff</span>
                    <ul style="margin-top: 1rem;">
                        <li>Access to all data (optional county filter)</li>
                        <li>Some fields masked (e.g., SSN, email)</li>
                        <li>Can approve timesheets</li>
                        <li>Can view team performance</li>
                        <li>Can run reports for assigned counties</li>
                    </ul>
                </div>
                <div class="role-card">
                    <h4>CASE_WORKER</h4>
                    <span class="role-badge badge-staff">Internal Staff</span>
                    <ul style="margin-top: 1rem;">
                        <li><strong>County restriction REQUIRED</strong></li>
                        <li>Can only access data from their county</li>
                        <li>More fields masked than SUPERVISOR</li>
                        <li>Can view and process caseloads</li>
                        <li>Can run county-specific reports</li>
                    </ul>
                </div>
                <div class="role-card">
                    <h4>PROVIDER</h4>
                    <span class="role-badge badge-external">External</span>
                    <ul style="margin-top: 1rem;">
                        <li>Access to own records only</li>
                        <li>Cannot see other providers' data</li>
                        <li>Can submit timesheets</li>
                        <li>Can view own payment history</li>
                        <li>Limited analytics access</li>
                    </ul>
                </div>
                <div class="role-card">
                    <h4>RECIPIENT</h4>
                    <span class="role-badge badge-external">External</span>
                    <ul style="margin-top: 1rem;">
                        <li>Access to own records only</li>
                        <li>Cannot see other recipients' data</li>
                        <li>Can approve timesheets for their care</li>
                        <li>Can view service history</li>
                        <li>Most restricted field visibility</li>
                    </ul>
                </div>
                <div class="role-card">
                    <h4>SYSTEM_SCHEDULER</h4>
                    <span class="role-badge badge-elevated">Elevated</span>
                    <span class="role-badge badge-staff">Internal Staff</span>
                    <ul style="margin-top: 1rem;">
                        <li>Used by scheduled batch jobs</li>
                        <li>Full access for report generation</li>
                        <li>Auto-assigned for service accounts</li>
                        <li>Generates reports for all counties</li>
                        <li>Not for interactive user sessions</li>
                    </ul>
                </div>
            </div>

            <h3>UserRole Enum Implementation</h3>
            <div class="code-block">
<span class="comment">// UserRole.java - Canonical CMIPS roles</span>
<span class="keyword">public enum</span> <span class="type">UserRole</span> {
    ADMIN(<span class="keyword">true</span>, <span class="keyword">true</span>),           <span class="comment">// internalStaff=true, elevated=true</span>
    SUPERVISOR(<span class="keyword">true</span>, <span class="keyword">false</span>),       <span class="comment">// internalStaff=true, elevated=false</span>
    CASE_WORKER(<span class="keyword">false</span>, <span class="keyword">false</span>),     <span class="comment">// internalStaff=false (requires county)</span>
    PROVIDER(<span class="keyword">false</span>, <span class="keyword">false</span>),        <span class="comment">// external user</span>
    RECIPIENT(<span class="keyword">false</span>, <span class="keyword">false</span>),       <span class="comment">// external user</span>
    SYSTEM_SCHEDULER(<span class="keyword">true</span>, <span class="keyword">true</span>); <span class="comment">// automated system role</span>

    <span class="keyword">private final boolean</span> internalStaff;
    <span class="keyword">private final boolean</span> elevated;

    <span class="comment">// Parse role from string - NO FALLBACK, throws exception if invalid</span>
    <span class="keyword">public static</span> UserRole <span class="function">from</span>(String value) {
        <span class="keyword">if</span> (value == <span class="keyword">null</span> || value.isBlank()) {
            <span class="keyword">throw new</span> IllegalArgumentException(
                <span class="string">"Role is required - cannot be null or empty. Role must be extracted from JWT token."</span>
            );
        }
        String normalized = value.trim().toUpperCase(Locale.ROOT);
        
        <span class="comment">// Handle service account prefix for scheduled jobs</span>
        <span class="keyword">if</span> (normalized.startsWith(<span class="string">"SERVICE-ACCOUNT-"</span>)) {
            <span class="keyword">return</span> SYSTEM_SCHEDULER;
        }
        
        <span class="keyword">try</span> {
            <span class="keyword">return</span> UserRole.valueOf(normalized);
        } <span class="keyword">catch</span> (IllegalArgumentException ex) {
            <span class="keyword">throw new</span> IllegalArgumentException(
                <span class="string">"Invalid role: '"</span> + value + <span class="string">"'. Must be one of: ADMIN, SUPERVISOR, CASE_WORKER, PROVIDER, RECIPIENT, SYSTEM_SCHEDULER"</span>
            );
        }
    }
}
            </div>
        </section>

        <!-- JWT Authentication -->
        <section class="section">
            <h2>üîë JWT Token Authentication</h2>

            <h3>JWT Token Structure</h3>
            <div class="jwt-structure">
                <div class="jwt-part">
                    <div class="jwt-part-name">Header</div>
                    <div class="jwt-part-color jwt-header">eyJhbGciOiJSUzI1...</div>
                    <p style="font-size: 0.85rem; color: var(--text-muted);">Algorithm & token type</p>
                </div>
                <div class="jwt-part">
                    <div class="jwt-part-name">Payload</div>
                    <div class="jwt-part-color jwt-payload">eyJzdWIiOiIxMjM0NQ...</div>
                    <p style="font-size: 0.85rem; color: var(--text-muted);">User claims (roles, county, etc.)</p>
                </div>
                <div class="jwt-part">
                    <div class="jwt-part-name">Signature</div>
                    <div class="jwt-part-color jwt-signature">SflKxwRJSMeKKF2QT...</div>
                    <p style="font-size: 0.85rem; color: var(--text-muted);">Keycloak RS256 signature</p>
                </div>
            </div>

            <h3>JWT Payload Claims Used</h3>
            <table>
                <tr>
                    <th>Claim</th>
                    <th>Path</th>
                    <th>Description</th>
                </tr>
                <tr>
                    <td>Client Roles</td>
                    <td><code>resource_access.trial-app.roles[]</code></td>
                    <td>Primary source for user roles (e.g., ["ADMIN"])</td>
                </tr>
                <tr>
                    <td>Realm Roles</td>
                    <td><code>realm_access.roles[]</code></td>
                    <td>Secondary source for roles if client roles not found</td>
                </tr>
                <tr>
                    <td>County ID</td>
                    <td><code>county_id</code></td>
                    <td>County code for data filtering (e.g., "CT1", "Orange")</td>
                </tr>
                <tr>
                    <td>Preferred Username</td>
                    <td><code>preferred_username</code></td>
                    <td>User's login username</td>
                </tr>
                <tr>
                    <td>Subject</td>
                    <td><code>sub</code></td>
                    <td>Unique user identifier (Keycloak user ID)</td>
                </tr>
                <tr>
                    <td>Issued At</td>
                    <td><code>iat</code></td>
                    <td>Token issue timestamp</td>
                </tr>
                <tr>
                    <td>Expiration</td>
                    <td><code>exp</code></td>
                    <td>Token expiration timestamp</td>
                </tr>
            </table>
        </section>

        <!-- Authentication Flow -->
        <section class="section">
            <h2>üîÑ Authentication Flow</h2>

            <div class="auth-flow">
                <div class="auth-step">
                    <div class="auth-step-num">1</div>
                    <div class="auth-step-content">
                        <div class="auth-step-title">User Initiates Login</div>
                        <div class="auth-step-desc">Frontend redirects user to Keycloak login page with client_id and redirect_uri</div>
                    </div>
                </div>
                <div class="auth-step">
                    <div class="auth-step-num">2</div>
                    <div class="auth-step-content">
                        <div class="auth-step-title">Keycloak Authentication</div>
                        <div class="auth-step-desc">User enters credentials. Keycloak validates against its user store and generates JWT token with claims (roles, county_id)</div>
                    </div>
                </div>
                <div class="auth-step">
                    <div class="auth-step-num">3</div>
                    <div class="auth-step-content">
                        <div class="auth-step-title">Token Returned to Frontend</div>
                        <div class="auth-step-desc">Keycloak redirects back to frontend with access_token and refresh_token. Frontend stores tokens in memory/localStorage</div>
                    </div>
                </div>
                <div class="auth-step">
                    <div class="auth-step-num">4</div>
                    <div class="auth-step-content">
                        <div class="auth-step-title">API Request with Bearer Token</div>
                        <div class="auth-step-desc">Frontend includes <code>Authorization: Bearer {token}</code> header on every API request</div>
                    </div>
                </div>
                <div class="auth-step">
                    <div class="auth-step-num">5</div>
                    <div class="auth-step-content">
                        <div class="auth-step-title">Backend JWT Validation</div>
                        <div class="auth-step-desc">Spring Security validates token signature using Keycloak's JWK endpoint, checks expiration, and extracts authorities</div>
                    </div>
                </div>
                <div class="auth-step">
                    <div class="auth-step-num">6</div>
                    <div class="auth-step-content">
                        <div class="auth-step-title">Request Processing</div>
                        <div class="auth-step-desc">If valid, request proceeds. Controller extracts role and county from token for data filtering and field masking</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Security Config -->
        <section class="section">
            <h2>‚öôÔ∏è SecurityConfig Implementation</h2>

            <h3>Spring Security Configuration</h3>
            <div class="code-block">
<span class="comment">// SecurityConfig.java - Main security configuration</span>
<span class="annotation">@Configuration</span>
<span class="annotation">@EnableWebSecurity</span>
<span class="keyword">public class</span> <span class="type">SecurityConfig</span> {

    <span class="annotation">@Bean</span>
    <span class="keyword">public</span> SecurityFilterChain <span class="function">filterChain</span>(HttpSecurity http) <span class="keyword">throws</span> Exception {
        http
            .cors(cors -> cors.configurationSource(<span class="function">corsConfigurationSource</span>()))
            .csrf(csrf -> csrf.disable())  <span class="comment">// Stateless API, no CSRF needed</span>
            .sessionManagement(session -> session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
            .authorizeHttpRequests(authz -> authz
                <span class="comment">// Public endpoints - static files and HTML pages</span>
                .requestMatchers(<span class="string">"/"</span>, <span class="string">"/index.html"</span>, <span class="string">"/static/**"</span>, <span class="string">"/*.html"</span>).permitAll()
                .requestMatchers(<span class="string">"/api/auth/**"</span>).permitAll()
                .requestMatchers(<span class="string">"/actuator/**"</span>).permitAll()
                
                <span class="comment">// Secured endpoints - require JWT authentication</span>
                .requestMatchers(<span class="string">"/api/analytics/**"</span>).authenticated()
                .requestMatchers(<span class="string">"/api/provider/**"</span>).authenticated()
                .requestMatchers(<span class="string">"/api/recipient/**"</span>).authenticated()
                .requestMatchers(<span class="string">"/api/pipeline/**"</span>).authenticated()
                .requestMatchers(<span class="string">"/api/field-masking/**"</span>).authenticated()
                .requestMatchers(<span class="string">"/api/reports/**"</span>).authenticated()
                .requestMatchers(<span class="string">"/api/bi/**"</span>).authenticated()
                
                <span class="comment">// All other API endpoints require authentication</span>
                .requestMatchers(<span class="string">"/api/**"</span>).authenticated()
                
                <span class="comment">// Static files remain public</span>
                .anyRequest().permitAll()
            )
            .oauth2ResourceServer(oauth2 -> oauth2
                .jwt(jwt -> jwt
                    .<span class="function">decoder</span>(<span class="function">jwtDecoder</span>())
                    .<span class="function">jwtAuthenticationConverter</span>(<span class="function">jwtAuthenticationConverter</span>())
                )
            );

        <span class="keyword">return</span> http.build();
    }
}
            </div>

            <h3>JWT Decoder with Flexible Issuer Validation</h3>
            <div class="code-block">
<span class="annotation">@Bean</span>
<span class="keyword">public</span> JwtDecoder <span class="function">jwtDecoder</span>() {
    <span class="comment">// Use Keycloak JWK endpoint for signature verification</span>
    String issuerUri = System.getenv().getOrDefault(
        <span class="string">"KEYCLOAK_ISSUER_URI"</span>, 
        <span class="string">"http://cmips-keycloak:8080/realms/cmips"</span>
    );
    String jwkSetUri = issuerUri + <span class="string">"/protocol/openid-connect/certs"</span>;
    
    NimbusJwtDecoder jwtDecoder = NimbusJwtDecoder.withJwkSetUri(jwkSetUri).build();
    
    <span class="comment">// Custom validator that accepts multiple issuer formats</span>
    <span class="comment">// (handles http/https, with/without port, Docker network vs localhost)</span>
    jwtDecoder.<span class="function">setJwtValidator</span>(token -> {
        String tokenIssuer = token.getIssuer() != <span class="keyword">null</span> ? token.getIssuer().toString() : <span class="string">""</span>;
        
        List&lt;String&gt; validIssuers = Arrays.asList(
            <span class="string">"http://cmips-keycloak:8080/realms/cmips"</span>,
            <span class="string">"https://cmips-keycloak:8080/realms/cmips"</span>,
            <span class="string">"http://localhost:8085/realms/cmips"</span>,
            <span class="string">"https://localhost:8085/realms/cmips"</span>,
            issuerUri
        );
        
        <span class="keyword">if</span> (validIssuers.stream().anyMatch(valid -> valid.equalsIgnoreCase(tokenIssuer))) {
            <span class="keyword">return</span> OAuth2TokenValidatorResult.success();
        }
        
        <span class="comment">// Also accept any issuer from cmips-keycloak for flexibility</span>
        <span class="keyword">if</span> (tokenIssuer.contains(<span class="string">"cmips-keycloak"</span>) && tokenIssuer.contains(<span class="string">"/realms/cmips"</span>)) {
            <span class="keyword">return</span> OAuth2TokenValidatorResult.success();
        }
        
        <span class="keyword">return</span> OAuth2TokenValidatorResult.failure(
            <span class="keyword">new</span> OAuth2Error(<span class="string">"invalid_issuer"</span>, <span class="string">"Invalid issuer: "</span> + tokenIssuer, <span class="keyword">null</span>)
        );
    });
    
    <span class="keyword">return</span> jwtDecoder;
}
            </div>

            <h3>JWT Authority Converter (Role Extraction)</h3>
            <div class="code-block">
<span class="annotation">@Bean</span>
<span class="keyword">public</span> JwtAuthenticationConverter <span class="function">jwtAuthenticationConverter</span>() {
    JwtAuthenticationConverter converter = <span class="keyword">new</span> JwtAuthenticationConverter();
    
    converter.<span class="function">setJwtGrantedAuthoritiesConverter</span>(jwt -> {
        Set&lt;GrantedAuthority&gt; authorities = <span class="keyword">new</span> HashSet&lt;&gt;();

        <span class="comment">// PRIMARY SOURCE: resource_access.trial-app.roles (CLIENT roles)</span>
        Map&lt;String, Object&gt; resourceAccess = jwt.getClaimAsMap(<span class="string">"resource_access"</span>);
        <span class="keyword">if</span> (resourceAccess != <span class="keyword">null</span>) {
            Map&lt;String, Object&gt; trialAppAccess = (Map) resourceAccess.get(<span class="string">"trial-app"</span>);
            <span class="keyword">if</span> (trialAppAccess != <span class="keyword">null</span>) {
                List&lt;String&gt; clientRoles = (List) trialAppAccess.get(<span class="string">"roles"</span>);
                <span class="keyword">if</span> (clientRoles != <span class="keyword">null</span> && !clientRoles.isEmpty()) {
                    System.out.println(<span class="string">"üîê Found CLIENT roles in JWT: "</span> + clientRoles);
                    clientRoles.stream()
                        .filter(role -> role != <span class="keyword">null</span>)
                        .<span class="function">map</span>(RoleMapper::canonicalName)  <span class="comment">// Normalize role name</span>
                        .distinct()
                        .map(role -> <span class="keyword">new</span> SimpleGrantedAuthority(<span class="string">"ROLE_"</span> + role))
                        .forEach(authorities::add);
                }
            }
        }

        <span class="comment">// SECONDARY SOURCE: realm_access.roles (if no client roles)</span>
        <span class="keyword">if</span> (authorities.isEmpty()) {
            Map&lt;String, Object&gt; realmAccess = jwt.getClaimAsMap(<span class="string">"realm_access"</span>);
            <span class="keyword">if</span> (realmAccess != <span class="keyword">null</span> && realmAccess.containsKey(<span class="string">"roles"</span>)) {
                List&lt;String&gt; roles = (List) realmAccess.get(<span class="string">"roles"</span>);
                System.out.println(<span class="string">"üîê Found REALM roles in JWT: "</span> + roles);
                roles.stream()
                    .filter(role -> role != <span class="keyword">null</span>)
                    .filter(role -> !role.startsWith(<span class="string">"default-roles-"</span>) &&
                                   !role.equals(<span class="string">"offline_access"</span>) &&
                                   !role.equals(<span class="string">"uma_authorization"</span>))
                    .map(RoleMapper::canonicalName)
                    .distinct()
                    .map(role -> <span class="keyword">new</span> SimpleGrantedAuthority(<span class="string">"ROLE_"</span> + role))
                    .forEach(authorities::add);
            }
        }

        <span class="comment">// NO FALLBACK - Authentication WILL FAIL if no valid roles</span>
        <span class="keyword">if</span> (authorities.isEmpty()) {
            System.err.println(<span class="string">"‚ùå NO VALID ROLES found in JWT token!"</span>);
            System.err.println(<span class="string">"‚ùå Authentication will FAIL - role must be in JWT"</span>);
        }

        <span class="keyword">return</span> authorities;
    });
    
    <span class="keyword">return</span> converter;
}
            </div>
        </section>

        <!-- Role Extraction in Controllers -->
        <section class="section">
            <h2>üì§ Role & County Extraction in Controllers</h2>

            <h3>Extracting Role from JWT Token</h3>
            <div class="code-block">
<span class="comment">// Example from AnalyticsController.java</span>
<span class="keyword">private</span> String <span class="function">extractRoleFromToken</span>(Jwt jwt) {
    String extractedRole = <span class="keyword">null</span>;
    
    <span class="comment">// Try client roles first (resource_access.trial-app.roles)</span>
    Map&lt;String, Object&gt; resourceAccess = jwt.getClaimAsMap(<span class="string">"resource_access"</span>);
    <span class="keyword">if</span> (resourceAccess != <span class="keyword">null</span>) {
        Map&lt;String, Object&gt; trialAppAccess = (Map) resourceAccess.get(<span class="string">"trial-app"</span>);
        <span class="keyword">if</span> (trialAppAccess != <span class="keyword">null</span>) {
            List&lt;String&gt; clientRoles = (List) trialAppAccess.get(<span class="string">"roles"</span>);
            <span class="keyword">if</span> (clientRoles != <span class="keyword">null</span> && !clientRoles.isEmpty()) {
                <span class="keyword">for</span> (String role : clientRoles) {
                    <span class="keyword">if</span> (role != <span class="keyword">null</span> && !role.trim().isEmpty()) {
                        extractedRole = RoleMapper.<span class="function">canonicalName</span>(role);
                        <span class="keyword">break</span>;
                    }
                }
            }
        }
    }
    
    <span class="comment">// Fall back to realm roles if no client role found</span>
    <span class="keyword">if</span> (extractedRole == <span class="keyword">null</span>) {
        Map&lt;String, Object&gt; realmAccess = jwt.getClaimAsMap(<span class="string">"realm_access"</span>);
        <span class="keyword">if</span> (realmAccess != <span class="keyword">null</span>) {
            List&lt;String&gt; roles = (List) realmAccess.get(<span class="string">"roles"</span>);
            <span class="keyword">if</span> (roles != <span class="keyword">null</span>) {
                <span class="keyword">for</span> (String role : roles) {
                    <span class="keyword">if</span> (role != <span class="keyword">null</span> && 
                        !role.startsWith(<span class="string">"default-roles-"</span>) &&
                        !role.equals(<span class="string">"offline_access"</span>) &&
                        !role.equals(<span class="string">"uma_authorization"</span>)) {
                        extractedRole = RoleMapper.<span class="function">canonicalName</span>(role);
                        <span class="keyword">break</span>;
                    }
                }
            }
        }
    }
    
    <span class="keyword">return</span> extractedRole;  <span class="comment">// Returns null if no valid role found</span>
}
            </div>

            <h3>Extracting County from JWT Token</h3>
            <div class="code-block">
<span class="comment">// County extraction - used for data filtering</span>
<span class="keyword">private</span> String <span class="function">extractCountyFromToken</span>(Jwt jwt) {
    <span class="comment">// Try county_id claim first</span>
    String county = jwt.getClaimAsString(<span class="string">"county_id"</span>);
    
    <span class="keyword">if</span> (county == <span class="keyword">null</span> || county.isEmpty()) {
        <span class="comment">// Try county claim as fallback</span>
        county = jwt.getClaimAsString(<span class="string">"county"</span>);
    }
    
    <span class="keyword">if</span> (county != <span class="keyword">null</span>) {
        <span class="comment">// Map county code to county name if needed</span>
        county = countyCodeMappingService.<span class="function">mapCountyCode</span>(county);
    }
    
    <span class="keyword">return</span> county;
}

<span class="comment">// County code mapping service</span>
<span class="keyword">public</span> String <span class="function">mapCountyCode</span>(String code) {
    <span class="keyword">if</span> (code == <span class="keyword">null</span>) <span class="keyword">return null</span>;
    
    <span class="comment">// Map CT1, CT2, etc. to actual county names</span>
    <span class="keyword">return switch</span> (code.toUpperCase()) {
        <span class="keyword">case</span> <span class="string">"CT1"</span> -> <span class="string">"Orange"</span>;
        <span class="keyword">case</span> <span class="string">"CT2"</span> -> <span class="string">"Sacramento"</span>;
        <span class="keyword">case</span> <span class="string">"CT3"</span> -> <span class="string">"Riverside"</span>;
        <span class="keyword">case</span> <span class="string">"CT4"</span> -> <span class="string">"Los Angeles"</span>;
        <span class="keyword">case</span> <span class="string">"CT5"</span> -> <span class="string">"Alameda"</span>;
        <span class="keyword">default</span> -> code;  <span class="comment">// Return as-is if not a code</span>
    };
}
            </div>
        </section>

        <!-- County Enforcement -->
        <section class="section">
            <h2>üè¢ County-Level Data Isolation</h2>

            <div class="danger-box">
                <strong>Critical Rule:</strong> CASE_WORKER, PROVIDER, and RECIPIENT roles MUST have a county in their JWT token. Requests without county for these roles will be rejected.
            </div>

            <h3>DataFetchingService County Enforcement</h3>
            <div class="code-block">
<span class="comment">// DataFetchingService.java - Role-based county enforcement</span>
<span class="keyword">public</span> DataFetchResult <span class="function">fetchData</span>(QueryParameters queryParams, <span class="keyword">int</span> page, <span class="keyword">int</span> pageSize) {
    UserRole role = UserRole.from(queryParams.getUserRole());
    String countyId = queryParams.getCountyId();
    
    <span class="keyword">switch</span> (role) {
        <span class="keyword">case</span> ADMIN, SYSTEM_SCHEDULER -> {
            <span class="comment">// Full access - county filter is OPTIONAL</span>
            <span class="keyword">if</span> (countyId != <span class="keyword">null</span> && !countyId.isEmpty()) {
                rawData = <span class="function">fetchCountyData</span>(queryParams, page, pageSize);
            } <span class="keyword">else</span> {
                rawData = <span class="function">fetchAllData</span>(queryParams, page, pageSize);
            }
        }
        
        <span class="keyword">case</span> SUPERVISOR -> {
            <span class="comment">// County filter is OPTIONAL (but recommended)</span>
            <span class="keyword">if</span> (countyId != <span class="keyword">null</span> && !countyId.isEmpty()) {
                rawData = <span class="function">fetchCountyData</span>(queryParams, page, pageSize);
            } <span class="keyword">else</span> {
                rawData = <span class="function">fetchAllData</span>(queryParams, page, pageSize);
            }
        }
        
        <span class="keyword">case</span> CASE_WORKER -> {
            <span class="comment">// ‚ö†Ô∏è County filter is REQUIRED - enforced</span>
            <span class="keyword">if</span> (countyId == <span class="keyword">null</span> || countyId.trim().isEmpty()) {
                <span class="keyword">throw new</span> IllegalArgumentException(
                    <span class="string">"Location filter is required for case workers. "</span> +
                    <span class="string">"Please select a county from the dropdown."</span>
                );
            }
            rawData = <span class="function">fetchCountyData</span>(queryParams, page, pageSize);
        }
        
        <span class="keyword">case</span> PROVIDER, RECIPIENT -> {
            <span class="comment">// Own records only - filter by user_id from JWT</span>
            rawData = <span class="function">fetchOwnRecordsData</span>(queryParams, page, pageSize);
        }
    }
    
    <span class="keyword">return new</span> DataFetchResult(<span class="keyword">true</span>, <span class="string">"Success"</span>, rawData, rawData.size(), totalCount);
}
            </div>

            <h3>County Filtering in Repository</h3>
            <div class="code-block">
<span class="comment">// TimesheetRepository.java - Native query with county filter</span>
<span class="annotation">@Query</span>(value = <span class="string">"SELECT * FROM timesheets t WHERE t.location = :county "</span> +
       <span class="string">"AND (:startDate IS NULL OR t.pay_period_start >= :startDate) "</span> +
       <span class="string">"AND (:endDate IS NULL OR t.pay_period_end <= :endDate) "</span> +
       <span class="string">"ORDER BY t.created_at DESC"</span>, 
       nativeQuery = <span class="keyword">true</span>)
List&lt;TimesheetEntity&gt; <span class="function">findByCountyAndDateRange</span>(
    <span class="annotation">@Param</span>(<span class="string">"county"</span>) String county,
    <span class="annotation">@Param</span>(<span class="string">"startDate"</span>) LocalDate startDate,
    <span class="annotation">@Param</span>(<span class="string">"endDate"</span>) LocalDate endDate,
    Pageable pageable
);
            </div>
        </section>

        <!-- CORS Configuration -->
        <section class="section">
            <h2>üåê CORS Configuration</h2>

            <div class="code-block">
<span class="annotation">@Bean</span>
<span class="keyword">public</span> CorsConfigurationSource <span class="function">corsConfigurationSource</span>() {
    CorsConfiguration config = <span class="keyword">new</span> CorsConfiguration();
    
    <span class="comment">// Allowed origins (API Gateway and frontend)</span>
    config.setAllowedOrigins(Arrays.asList(
        <span class="string">"http://api-gateway:8080"</span>,
        <span class="string">"http://localhost:8090"</span>,
        <span class="string">"http://localhost:3000"</span>,  <span class="comment">// Next.js dev server</span>
        <span class="string">"http://localhost:3001"</span>,
        <span class="string">"http://127.0.0.1:3000"</span>,
        <span class="string">"http://127.0.0.1:3001"</span>
    ));
    
    <span class="comment">// Also allow patterns for flexibility</span>
    config.setAllowedOriginPatterns(Arrays.asList(
        <span class="string">"http://api-gateway:*"</span>,
        <span class="string">"http://localhost:*"</span>,
        <span class="string">"http://127.0.0.1:*"</span>
    ));
    
    <span class="comment">// Allowed HTTP methods</span>
    config.setAllowedMethods(Arrays.asList(
        <span class="string">"GET"</span>, <span class="string">"POST"</span>, <span class="string">"PUT"</span>, <span class="string">"DELETE"</span>, <span class="string">"OPTIONS"</span>, <span class="string">"PATCH"</span>
    ));
    
    <span class="comment">// Allowed headers (including custom headers)</span>
    config.setAllowedHeaders(Arrays.asList(
        <span class="string">"Authorization"</span>,       <span class="comment">// JWT token</span>
        <span class="string">"Content-Type"</span>,        <span class="comment">// Request body type</span>
        <span class="string">"Accept"</span>,              <span class="comment">// Response type</span>
        <span class="string">"Origin"</span>,              <span class="comment">// CORS origin</span>
        <span class="string">"X-Requested-With"</span>,    <span class="comment">// AJAX indicator</span>
        <span class="string">"X-User-Id"</span>,           <span class="comment">// Custom user header</span>
        <span class="string">"X-User-Name"</span>,         <span class="comment">// Custom user header</span>
        <span class="string">"X-User-Email"</span>,        <span class="comment">// Custom user header</span>
        <span class="string">"X-User-Roles"</span>         <span class="comment">// Custom user header</span>
    ));
    
    <span class="comment">// Headers exposed to frontend</span>
    config.setExposedHeaders(Arrays.asList(<span class="string">"Authorization"</span>, <span class="string">"Content-Disposition"</span>));
    
    <span class="comment">// Allow credentials (cookies, Authorization header)</span>
    config.setAllowCredentials(<span class="keyword">true</span>);
    
    <span class="comment">// Cache preflight for 1 hour</span>
    config.setMaxAge(<span class="number">3600L</span>);
    
    UrlBasedCorsConfigurationSource source = <span class="keyword">new</span> UrlBasedCorsConfigurationSource();
    source.registerCorsConfiguration(<span class="string">"/**"</span>, config);
    <span class="keyword">return</span> source;
}
            </div>
        </section>

        <!-- Security Best Practices -->
        <section class="section">
            <h2>‚úÖ Security Best Practices Implemented</h2>

            <div class="success-box">
                <h4>What We Do Right</h4>
                <ul style="margin-top: 0.5rem;">
                    <li><strong>No Role Fallback:</strong> If JWT doesn't contain a valid role, authentication fails. No default "guest" role.</li>
                    <li><strong>JWT-Only Processing:</strong> All report generation requires JWT token - no bypass methods.</li>
                    <li><strong>Stateless Sessions:</strong> No server-side session storage. Each request is independently authenticated.</li>
                    <li><strong>Token Signature Verification:</strong> JWT signatures verified against Keycloak's public keys (JWK endpoint).</li>
                    <li><strong>Token Expiration:</strong> Expired tokens are rejected automatically by Spring Security.</li>
                    <li><strong>County Enforcement:</strong> Restricted roles cannot access data outside their assigned county.</li>
                    <li><strong>Field Masking:</strong> Sensitive data is masked based on role, even if data is accessible.</li>
                    <li><strong>CORS Restrictions:</strong> Only whitelisted origins can make requests.</li>
                </ul>
            </div>

            <div class="warning-box">
                <h4>Important Security Notes</h4>
                <ul style="margin-top: 0.5rem;">
                    <li>JWT tokens contain sensitive claims - never log full tokens in production</li>
                    <li>Token storage in localStorage is vulnerable to XSS - consider httpOnly cookies for production</li>
                    <li>Always use HTTPS in production to prevent token interception</li>
                    <li>Implement token refresh logic before expiration to maintain user sessions</li>
                    <li>Keycloak realm/client configuration must match backend expectations</li>
                </ul>
            </div>
        </section>

        <!-- Troubleshooting -->
        <section class="section">
            <h2>üîß Authentication Troubleshooting</h2>

            <table>
                <tr>
                    <th>Error</th>
                    <th>Likely Cause</th>
                    <th>Solution</th>
                </tr>
                <tr>
                    <td>401 Unauthorized</td>
                    <td>Missing or invalid JWT token</td>
                    <td>Ensure Authorization header is set with "Bearer {token}"</td>
                </tr>
                <tr>
                    <td>Invalid Issuer</td>
                    <td>Token from wrong Keycloak realm</td>
                    <td>Verify KEYCLOAK_ISSUER_URI environment variable</td>
                </tr>
                <tr>
                    <td>No Valid Roles Found</td>
                    <td>Role not in expected JWT claim location</td>
                    <td>Check resource_access.trial-app.roles or realm_access.roles</td>
                </tr>
                <tr>
                    <td>County Required</td>
                    <td>CASE_WORKER without county_id claim</td>
                    <td>Add county_id mapper in Keycloak client configuration</td>
                </tr>
                <tr>
                    <td>CORS Error</td>
                    <td>Origin not in allowed list</td>
                    <td>Add origin to CORS configuration or use allowedOriginPatterns</td>
                </tr>
                <tr>
                    <td>Token Expired</td>
                    <td>JWT exp claim is in the past</td>
                    <td>Refresh token or re-authenticate with Keycloak</td>
                </tr>
            </table>
        </section>

        <!-- Footer -->
        <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
            <p>Security & Authentication Deep Dive | IHSS/CMIPS Timesheet Management System</p>
            <p>Generated: December 8, 2025</p>
        </div>
    </div>
</body>
</html>

