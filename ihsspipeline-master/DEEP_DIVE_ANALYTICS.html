<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deep Dive: Analytics Implementation - IHSS/CMIPS System</title>
    <style>
        :root {
            --primary: #0f172a;
            --secondary: #1e293b;
            --accent: #3b82f6;
            --accent-light: #60a5fa;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text: #e2e8f0;
            --text-muted: #94a3b8;
            --code-bg: #1e1e1e;
            --border: #334155;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, #0c1220 100%);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.7;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            text-align: center;
            padding: 4rem 2rem;
            background: linear-gradient(180deg, rgba(59, 130, 246, 0.1) 0%, transparent 100%);
            border-bottom: 1px solid var(--border);
            margin-bottom: 3rem;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
        }

        .header .subtitle {
            font-size: 1.25rem;
            color: var(--text-muted);
        }

        .nav {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .nav a {
            padding: 0.75rem 1.5rem;
            background: var(--secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav a:hover {
            background: var(--accent);
            border-color: var(--accent);
        }

        .section {
            background: var(--secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2.5rem;
            margin-bottom: 2rem;
        }

        .section h2 {
            font-size: 1.75rem;
            color: var(--accent-light);
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--accent);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .section h3 {
            font-size: 1.25rem;
            color: var(--text);
            margin: 1.5rem 0 1rem;
        }

        .section h4 {
            font-size: 1.1rem;
            color: var(--accent-light);
            margin: 1.25rem 0 0.75rem;
        }

        .code-block {
            background: var(--code-bg);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
            overflow-x: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.6;
            border: 1px solid var(--border);
        }

        .code-block .comment {
            color: #6a9955;
        }

        .code-block .keyword {
            color: #569cd6;
        }

        .code-block .string {
            color: #ce9178;
        }

        .code-block .function {
            color: #dcdcaa;
        }

        .code-block .annotation {
            color: #c586c0;
        }

        .code-block .type {
            color: #4ec9b0;
        }

        .code-block .number {
            color: #b5cea8;
        }

        .flow-diagram {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 12px;
            padding: 2rem;
            margin: 1.5rem 0;
            border: 1px solid var(--border);
        }

        .flow-step {
            display: flex;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            position: relative;
            padding-left: 3rem;
        }

        .flow-step:not(:last-child)::before {
            content: '';
            position: absolute;
            left: 1rem;
            top: 2.5rem;
            height: calc(100% + 0.5rem);
            width: 2px;
            background: linear-gradient(180deg, var(--accent) 0%, var(--accent-light) 100%);
        }

        .flow-step .step-number {
            position: absolute;
            left: 0;
            width: 2rem;
            height: 2rem;
            background: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .flow-step .step-content {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid var(--accent);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            flex: 1;
        }

        .flow-step .step-title {
            font-weight: 600;
            color: var(--accent-light);
            margin-bottom: 0.5rem;
        }

        .table-container {
            overflow-x: auto;
            margin: 1rem 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border: 1px solid var(--border);
        }

        th {
            background: rgba(59, 130, 246, 0.2);
            font-weight: 600;
            color: var(--accent-light);
        }

        tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.02);
        }

        .highlight-box {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(96, 165, 250, 0.05) 100%);
            border-left: 4px solid var(--accent);
            padding: 1.5rem;
            border-radius: 0 8px 8px 0;
            margin: 1rem 0;
        }

        .warning-box {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%);
            border-left: 4px solid var(--warning);
            padding: 1.5rem;
            border-radius: 0 8px 8px 0;
            margin: 1rem 0;
        }

        .success-box {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);
            border-left: 4px solid var(--success);
            padding: 1.5rem;
            border-radius: 0 8px 8px 0;
            margin: 1rem 0;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
        }

        .card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .card h4 {
            color: var(--accent-light);
            margin-bottom: 1rem;
        }

        ul, ol {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }

        li {
            margin-bottom: 0.5rem;
        }

        .endpoint-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .get { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .post { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .put { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .delete { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

        .toc {
            background: var(--secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .toc h3 {
            margin-bottom: 1rem;
        }

        .toc ul {
            list-style: none;
            margin: 0;
        }

        .toc li {
            margin-bottom: 0.5rem;
        }

        .toc a {
            color: var(--text-muted);
            text-decoration: none;
            transition: color 0.2s;
        }

        .toc a:hover {
            color: var(--accent-light);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section {
            animation: fadeIn 0.5s ease-out;
        }

        .metric-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(59, 130, 246, 0.05) 100%);
            border: 1px solid var(--accent);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
        }

        .metric-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-light);
        }

        .metric-card .label {
            color: var(--text-muted);
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç Analytics Deep Dive</h1>
        <p class="subtitle">Complete Implementation Guide for Dashboard Analytics System</p>
        <div class="nav">
            <a href="#architecture">Architecture</a>
            <a href="#endpoints">API Endpoints</a>
            <a href="#data-flow">Data Flow</a>
            <a href="#code-walkthrough">Code Walkthrough</a>
            <a href="#security">Security</a>
            <a href="#performance">Performance</a>
        </div>
    </div>

    <div class="container">
        <div class="toc">
            <h3>üìã Table of Contents</h3>
            <ul>
                <li><a href="#architecture">1. System Architecture Overview</a></li>
                <li><a href="#endpoints">2. Complete API Endpoint Reference</a></li>
                <li><a href="#data-flow">3. Data Flow & Processing Pipeline</a></li>
                <li><a href="#code-walkthrough">4. Detailed Code Walkthrough</a></li>
                <li><a href="#security">5. Security & Access Control</a></li>
                <li><a href="#performance">6. Performance Optimization</a></li>
                <li><a href="#frontend">7. Frontend Integration</a></li>
                <li><a href="#faq">8. FAQ & Troubleshooting</a></li>
            </ul>
        </div>

        <!-- Section 1: Architecture -->
        <section id="architecture" class="section">
            <h2>üìê 1. System Architecture Overview</h2>
            
            <h3>1.1 Component Overview</h3>
            <p>The Analytics system is built on a layered architecture that separates concerns and enables scalability:</p>
            
            <div class="flow-diagram">
                <div class="flow-step">
                    <span class="step-number">1</span>
                    <div class="step-content">
                        <div class="step-title">Frontend (Next.js)</div>
                        <p><code>app/analytics/page.tsx</code> - React components with Chart.js visualization. Calls <code>analytics.service.ts</code> for API communication.</p>
                    </div>
                </div>
                <div class="flow-step">
                    <span class="step-number">2</span>
                    <div class="step-content">
                        <div class="step-title">Analytics Service (TypeScript)</div>
                        <p><code>lib/services/analytics.service.ts</code> - HTTP client with JWT authentication. Handles request/response transformation.</p>
                    </div>
                </div>
                <div class="flow-step">
                    <span class="step-number">3</span>
                    <div class="step-content">
                        <div class="step-title">REST Controller (Spring Boot)</div>
                        <p><code>AnalyticsController.java</code> - 15+ endpoints handling realtime metrics, demographics, adhoc queries, and filter options.</p>
                    </div>
                </div>
                <div class="flow-step">
                    <span class="step-number">4</span>
                    <div class="step-content">
                        <div class="step-title">Repository Layer (JPA)</div>
                        <p><code>TimesheetRepository.java</code> - 50+ custom queries using JPQL and native SQL with optional parameter handling.</p>
                    </div>
                </div>
                <div class="flow-step">
                    <span class="step-number">5</span>
                    <div class="step-content">
                        <div class="step-title">PostgreSQL Database</div>
                        <p><code>timesheets</code> table with demographic fields, location data, hours breakdown, and status tracking.</p>
                    </div>
                </div>
            </div>

            <h3>1.2 Key Classes & Their Responsibilities</h3>
            <div class="table-container">
                <table>
                    <tr>
                        <th>Class</th>
                        <th>File Location</th>
                        <th>Responsibility</th>
                        <th>Lines of Code</th>
                    </tr>
                    <tr>
                        <td><code>AnalyticsController</code></td>
                        <td><code>controller/AnalyticsController.java</code></td>
                        <td>REST API endpoints, JWT extraction, parameter normalization</td>
                        <td>~1060 lines</td>
                    </tr>
                    <tr>
                        <td><code>TimesheetRepository</code></td>
                        <td><code>repository/TimesheetRepository.java</code></td>
                        <td>Database queries, count operations, distinct value lookups</td>
                        <td>~273 lines</td>
                    </tr>
                    <tr>
                        <td><code>analytics.service.ts</code></td>
                        <td><code>lib/services/analytics.service.ts</code></td>
                        <td>Frontend API client with authentication headers</td>
                        <td>~200 lines</td>
                    </tr>
                </table>
            </div>
        </section>

        <!-- Section 2: API Endpoints -->
        <section id="endpoints" class="section">
            <h2>üîå 2. Complete API Endpoint Reference</h2>

            <h3>2.1 Real-Time Metrics Endpoint</h3>
            <div class="highlight-box">
                <span class="endpoint-badge get">GET</span>
                <code>/api/analytics/realtime-metrics</code>
            </div>

            <h4>Purpose</h4>
            <p>Provides dashboard KPIs including today's submissions, pending approvals, distinct employees, and average approval time.</p>

            <h4>Request Parameters</h4>
            <div class="table-container">
                <table>
                    <tr>
                        <th>Parameter</th>
                        <th>Type</th>
                        <th>Required</th>
                        <th>Description</th>
                    </tr>
                    <tr>
                        <td><code>districtId</code></td>
                        <td>String</td>
                        <td>No</td>
                        <td>Filter by district (not used in current schema)</td>
                    </tr>
                    <tr>
                        <td><code>county</code></td>
                        <td>String</td>
                        <td>No*</td>
                        <td>County filter - overridden by JWT for restricted roles</td>
                    </tr>
                    <tr>
                        <td><code>status</code></td>
                        <td>String</td>
                        <td>No</td>
                        <td>Filter by timesheet status (SUBMITTED, APPROVED, etc.)</td>
                    </tr>
                    <tr>
                        <td><code>startYear</code></td>
                        <td>String</td>
                        <td>No</td>
                        <td>Start year for date range filtering</td>
                    </tr>
                    <tr>
                        <td><code>endYear</code></td>
                        <td>String</td>
                        <td>No</td>
                        <td>End year for date range filtering</td>
                    </tr>
                </table>
            </div>

            <h4>Actual Implementation Code</h4>
            <div class="code-block">
<span class="annotation">@GetMapping</span>(<span class="string">"/realtime-metrics"</span>)
<span class="keyword">public</span> ResponseEntity&lt;Map&lt;String, Object&gt;&gt; <span class="function">getRealTimeMetrics</span>(
        <span class="annotation">@RequestParam</span>(required = <span class="keyword">false</span>) String districtId,
        <span class="annotation">@RequestParam</span>(required = <span class="keyword">false</span>) String county,
        <span class="annotation">@RequestParam</span>(required = <span class="keyword">false</span>) String status,
        <span class="annotation">@RequestParam</span>(required = <span class="keyword">false</span>) String startYear,
        <span class="annotation">@RequestParam</span>(required = <span class="keyword">false</span>) String endYear) {
    
    <span class="comment">// Step 1: Extract user info from JWT token</span>
    Map&lt;String, Object&gt; userInfo = <span class="function">extractUserInfoFromJwt</span>();
    String userRole = userInfo.get(<span class="string">"role"</span>) != <span class="keyword">null</span> ? userInfo.get(<span class="string">"role"</span>).toString() : <span class="keyword">null</span>;
    String tokenCounty = userInfo.get(<span class="string">"countyId"</span>) != <span class="keyword">null</span> ? userInfo.get(<span class="string">"countyId"</span>).toString() : <span class="keyword">null</span>;
    
    <span class="comment">// Step 2: Resolve county filter with JWT enforcement</span>
    String countyFilter = <span class="function">resolveCountyFilter</span>(county, userRole, tokenCounty);
    
    <span class="comment">// Step 3: Normalize parameters</span>
    String districtFilter = <span class="function">normalizeParam</span>(districtId);
    String statusFilter = <span class="function">normalizeParam</span>(status);
    LocalDateTime createdAfter = <span class="function">resolveStartDate</span>(startYear);
    LocalDateTime createdBefore = <span class="function">resolveEndDate</span>(endYear);
    
    <span class="comment">// Step 4: Query database using repository methods</span>
    <span class="keyword">long</span> totalTimesheetsToday = timesheetRepository.<span class="function">countCreatedAfterWithFilters</span>(
        startOfToday, createdBefore, countyFilter, serviceTypeFilter, statusFilter
    );
    
    <span class="keyword">long</span> pendingApprovals = timesheetRepository.<span class="function">countPendingApprovalsWithFilters</span>(
        countyFilter, serviceTypeFilter, statusFilter, createdAfter, createdBefore
    );
    
    <span class="keyword">long</span> distinctEmployees = timesheetRepository.<span class="function">countDistinctEmployeesWithFilters</span>(
        countyFilter, serviceTypeFilter, statusFilter, createdAfter, createdBefore
    );
    
    Double avgApprovalTime = timesheetRepository.<span class="function">avgApprovalTimeHoursWithFilters</span>(
        countyFilter, serviceTypeFilter, createdAfter, createdBefore
    );
    
    <span class="comment">// Step 5: Build and return response</span>
    metrics.put(<span class="string">"totalTimesheetsToday"</span>, totalTimesheetsToday);
    metrics.put(<span class="string">"pendingApprovals"</span>, pendingApprovals);
    metrics.put(<span class="string">"distinctEmployees"</span>, distinctEmployees);
    metrics.put(<span class="string">"avgApprovalTimeHours"</span>, avgApprovalTime);
    metrics.put(<span class="string">"lastUpdated"</span>, LocalDateTime.now());
    
    <span class="keyword">return</span> ResponseEntity.ok(metrics);
}
            </div>

            <h4>Response Example</h4>
            <div class="code-block">
{
    <span class="string">"totalTimesheetsToday"</span>: <span class="number">127</span>,
    <span class="string">"pendingApprovals"</span>: <span class="number">43</span>,
    <span class="string">"totalParticipants"</span>: <span class="number">89</span>,
    <span class="string">"distinctEmployees"</span>: <span class="number">89</span>,
    <span class="string">"avgApprovalTimeHours"</span>: <span class="number">4.5</span>,
    <span class="string">"lastUpdated"</span>: <span class="string">"2025-12-08T10:30:00"</span>,
    <span class="string">"status"</span>: <span class="string">"SUCCESS"</span>
}
            </div>

            <h3>2.2 Ad-Hoc Data Endpoint</h3>
            <div class="highlight-box">
                <span class="endpoint-badge get">GET</span>
                <code>/api/analytics/adhoc-data</code>
            </div>

            <h4>Purpose</h4>
            <p>Provides raw timesheet data with demographic fields for custom reporting and analysis. Supports pagination and filtering.</p>

            <h4>Key Implementation Details</h4>
            <ul>
                <li><strong>Pagination:</strong> Uses <code>limit</code> parameter (default: 200, max: 1000) to prevent memory issues</li>
                <li><strong>County Enforcement:</strong> JWT token county overrides request parameter for restricted roles</li>
                <li><strong>Field Mapping:</strong> Returns both camelCase and snake_case versions for frontend compatibility</li>
            </ul>

            <div class="code-block">
<span class="comment">// Columns returned (aligned with TimesheetEntity schema)</span>
List&lt;String&gt; columns = List.of(
    <span class="string">"id"</span>, <span class="string">"employeeId"</span>, <span class="string">"employeeName"</span>, <span class="string">"userId"</span>, 
    <span class="string">"department"</span>, <span class="string">"location"</span>, <span class="string">"payPeriodStart"</span>, <span class="string">"payPeriodEnd"</span>,
    <span class="string">"regularHours"</span>, <span class="string">"overtimeHours"</span>, <span class="string">"sickHours"</span>, <span class="string">"vacationHours"</span>,
    <span class="string">"holidayHours"</span>, <span class="string">"totalHours"</span>, <span class="string">"status"</span>, <span class="string">"comments"</span>,
    <span class="string">"submittedAt"</span>, <span class="string">"approvedAt"</span>, <span class="string">"createdAt"</span>, <span class="string">"updatedAt"</span>,
    <span class="comment">// Demographic fields</span>
    <span class="string">"providerGender"</span>, <span class="string">"providerEthnicity"</span>, <span class="string">"providerAgeGroup"</span>,
    <span class="string">"recipientGender"</span>, <span class="string">"recipientEthnicity"</span>, <span class="string">"recipientAgeGroup"</span>
);

<span class="comment">// Query with pagination to prevent OutOfMemoryError</span>
<span class="keyword">int</span> sanitizedLimit = Math.max(<span class="number">10</span>, Math.min(limit, <span class="number">1000</span>));

<span class="keyword">if</span> (countyFilter != <span class="keyword">null</span>) {
    timesheets = timesheetRepository.<span class="function">findByLocationWithPagination</span>(
        countyFilter, <span class="number">0</span>, sanitizedLimit
    );
} <span class="keyword">else</span> {
    timesheets = timesheetRepository.<span class="function">findMostRecentWithLimit</span>(sanitizedLimit);
}
            </div>

            <h3>2.3 Demographics Endpoints</h3>
            
            <div class="grid-2">
                <div class="card">
                    <h4><span class="endpoint-badge get">GET</span> /demographics/gender</h4>
                    <p>Returns gender distribution for both providers and recipients.</p>
                    <div class="code-block">
<span class="comment">// Query from repository</span>
List&lt;Object[]&gt; providerGender = 
    timesheetRepository.<span class="function">countByProviderGender</span>();
List&lt;Object[]&gt; recipientGender = 
    timesheetRepository.<span class="function">countByRecipientGender</span>();

<span class="comment">// Response structure</span>
{
  <span class="string">"provider"</span>: {<span class="string">"Male"</span>: <span class="number">45</span>, <span class="string">"Female"</span>: <span class="number">55</span>},
  <span class="string">"recipient"</span>: {<span class="string">"Male"</span>: <span class="number">40</span>, <span class="string">"Female"</span>: <span class="number">60</span>}
}
                    </div>
                </div>
                <div class="card">
                    <h4><span class="endpoint-badge get">GET</span> /demographics/ethnicity</h4>
                    <p>Returns ethnicity distribution for both providers and recipients.</p>
                    <div class="code-block">
<span class="comment">// Query from repository</span>
List&lt;Object[]&gt; providerEthnicity = 
    timesheetRepository.<span class="function">countByProviderEthnicity</span>();
List&lt;Object[]&gt; recipientEthnicity = 
    timesheetRepository.<span class="function">countByRecipientEthnicity</span>();

<span class="comment">// Response structure</span>
{
  <span class="string">"provider"</span>: {<span class="string">"Hispanic"</span>: <span class="number">30</span>, ...},
  <span class="string">"recipient"</span>: {<span class="string">"Hispanic"</span>: <span class="number">25</span>, ...}
}
                    </div>
                </div>
            </div>

            <h3>2.4 Filter Options Endpoint</h3>
            <div class="highlight-box">
                <span class="endpoint-badge get">GET</span>
                <code>/api/analytics/adhoc-filters</code>
            </div>

            <p>Returns all available filter options for the analytics UI. This endpoint powers dropdown menus.</p>

            <div class="code-block">
<span class="annotation">@GetMapping</span>(<span class="string">"/adhoc-filters"</span>)
<span class="keyword">public</span> ResponseEntity&lt;Map&lt;String, Object&gt;&gt; <span class="function">getAdhocFilterOptions</span>() {
    <span class="comment">// Extract user info to filter available options by county if restricted</span>
    Map&lt;String, Object&gt; userInfo = <span class="function">extractUserInfoFromJwt</span>();
    
    <span class="comment">// Get distinct values from database</span>
    List&lt;String&gt; locations = timesheetRepository.<span class="function">findDistinctLocations</span>();
    List&lt;String&gt; departments = timesheetRepository.<span class="function">findDistinctDepartments</span>();
    List&lt;String&gt; statuses = timesheetRepository.<span class="function">findDistinctStatuses</span>();
    
    <span class="comment">// Demographic field options (separated for provider/recipient)</span>
    List&lt;String&gt; providerGenders = timesheetRepository.<span class="function">findDistinctProviderGenders</span>();
    List&lt;String&gt; recipientGenders = timesheetRepository.<span class="function">findDistinctRecipientGenders</span>();
    List&lt;String&gt; providerEthnicities = timesheetRepository.<span class="function">findDistinctProviderEthnicities</span>();
    List&lt;String&gt; recipientEthnicities = timesheetRepository.<span class="function">findDistinctRecipientEthnicities</span>();
    List&lt;String&gt; providerAgeGroups = timesheetRepository.<span class="function">findDistinctProviderAgeGroups</span>();
    List&lt;String&gt; recipientAgeGroups = timesheetRepository.<span class="function">findDistinctRecipientAgeGroups</span>();
    
    <span class="keyword">return</span> ResponseEntity.ok(response);
}
            </div>
        </section>

        <!-- Section 3: Data Flow -->
        <section id="data-flow" class="section">
            <h2>üîÑ 3. Data Flow & Processing Pipeline</h2>

            <h3>3.1 Request Processing Flow</h3>
            <div class="flow-diagram">
                <div class="flow-step">
                    <span class="step-number">1</span>
                    <div class="step-content">
                        <div class="step-title">Frontend Request</div>
                        <p>User selects filters in the Analytics UI. <code>analytics.service.ts</code> builds the request URL with query parameters and attaches JWT token in Authorization header.</p>
                    </div>
                </div>
                <div class="flow-step">
                    <span class="step-number">2</span>
                    <div class="step-content">
                        <div class="step-title">JWT Token Extraction</div>
                        <p><code>extractUserInfoFromJwt()</code> parses the JWT from <code>SecurityContextHolder</code>. Extracts <code>role</code> from <code>resource_access.trial-app.roles</code> or <code>realm_access.roles</code>, and <code>countyId</code> from token attributes.</p>
                    </div>
                </div>
                <div class="flow-step">
                    <span class="step-number">3</span>
                    <div class="step-content">
                        <div class="step-title">County Filter Resolution</div>
                        <p><code>resolveCountyFilter()</code> enforces county restrictions for SUPERVISOR, CASE_WORKER, PROVIDER, and RECIPIENT roles. Token county overrides request parameter.</p>
                    </div>
                </div>
                <div class="flow-step">
                    <span class="step-number">4</span>
                    <div class="step-content">
                        <div class="step-title">Parameter Normalization</div>
                        <p><code>normalizeParam()</code> trims whitespace, converts "all" to null, and handles empty strings. Date parameters are parsed from year strings.</p>
                    </div>
                </div>
                <div class="flow-step">
                    <span class="step-number">5</span>
                    <div class="step-content">
                        <div class="step-title">Database Query Execution</div>
                        <p>Repository methods execute optimized SQL queries with optional parameter handling. Uses native SQL for complex aggregations.</p>
                    </div>
                </div>
                <div class="flow-step">
                    <span class="step-number">6</span>
                    <div class="step-content">
                        <div class="step-title">Response Building</div>
                        <p>Results are transformed into JSON response with status, timestamp, and data. Error handling wraps exceptions with meaningful messages.</p>
                    </div>
                </div>
            </div>

            <h3>3.2 County Filter Enforcement Logic</h3>
            <div class="warning-box">
                <strong>‚ö†Ô∏è Security Critical:</strong> County filtering is enforced server-side based on JWT token. Frontend filter selections cannot bypass this restriction.
            </div>

            <div class="code-block">
<span class="keyword">private</span> String <span class="function">resolveCountyFilter</span>(String requestedCounty, String userRole, String tokenCounty) {
    String normalizedRole = userRole != <span class="keyword">null</span> ? userRole.toUpperCase() : <span class="string">""</span>;
    
    <span class="comment">// Roles that REQUIRE county from JWT token (no override allowed)</span>
    <span class="keyword">if</span> (normalizedRole.contains(<span class="string">"SUPERVISOR"</span>) || 
        normalizedRole.contains(<span class="string">"CASE_WORKER"</span>) || 
        normalizedRole.contains(<span class="string">"PROVIDER"</span>) || 
        normalizedRole.contains(<span class="string">"RECIPIENT"</span>)) {
        
        <span class="keyword">if</span> (tokenCounty != <span class="keyword">null</span> && !tokenCounty.trim().isEmpty()) {
            log.debug(<span class="string">"Enforcing county restriction for role {}: using token county {}"</span>, 
                      userRole, tokenCounty);
            <span class="keyword">return</span> tokenCounty;  <span class="comment">// Always use token county</span>
        }
        log.warn(<span class="string">"Role {} requires county from JWT token but none found"</span>, userRole);
        <span class="keyword">return null</span>;  <span class="comment">// Will cause filtering to fail</span>
    }
    
    <span class="comment">// For ADMIN/SYSTEM_SCHEDULER: prefer token county but allow requested</span>
    <span class="keyword">if</span> (tokenCounty != <span class="keyword">null</span> && !tokenCounty.trim().isEmpty()) {
        <span class="keyword">return</span> tokenCounty;
    }
    
    <span class="keyword">return</span> <span class="function">normalizeParam</span>(requestedCounty);
}
            </div>
        </section>

        <!-- Section 4: Code Walkthrough -->
        <section id="code-walkthrough" class="section">
            <h2>üíª 4. Detailed Code Walkthrough</h2>

            <h3>4.1 Repository Query Methods</h3>
            <p>The <code>TimesheetRepository</code> uses native SQL queries for complex analytics operations with optional parameter handling:</p>

            <div class="code-block">
<span class="comment">// Count created after with multiple optional filters</span>
<span class="annotation">@Query</span>(value = <span class="string">"SELECT COUNT(*) FROM timesheets "</span> +
        <span class="string">"WHERE (:createdAfter IS NULL OR created_at >= :createdAfter) "</span> +
        <span class="string">"AND (:createdBefore IS NULL OR created_at <= :createdBefore) "</span> +
        <span class="string">"AND (:location IS NULL OR location = :location) "</span> +
        <span class="string">"AND (:department IS NULL OR department = :department) "</span> +
        <span class="string">"AND (:statusFilter IS NULL OR status = :statusFilter)"</span>, nativeQuery = <span class="keyword">true</span>)
<span class="keyword">long</span> <span class="function">countCreatedAfterWithFilters</span>(
    <span class="annotation">@Param</span>(<span class="string">"createdAfter"</span>) LocalDateTime createdAfter,
    <span class="annotation">@Param</span>(<span class="string">"createdBefore"</span>) LocalDateTime createdBefore,
    <span class="annotation">@Param</span>(<span class="string">"location"</span>) String location,
    <span class="annotation">@Param</span>(<span class="string">"department"</span>) String department,
    <span class="annotation">@Param</span>(<span class="string">"statusFilter"</span>) String statusFilter
);

<span class="comment">// Average approval time calculation (in hours)</span>
<span class="annotation">@Query</span>(value = <span class="string">"SELECT AVG(EXTRACT(EPOCH FROM (approved_at - submitted_at))/3600) "</span> +
        <span class="string">"FROM timesheets "</span> +
        <span class="string">"WHERE status = 'APPROVED' "</span> +
        <span class="string">"AND submitted_at IS NOT NULL "</span> +
        <span class="string">"AND approved_at IS NOT NULL "</span> +
        <span class="string">"AND (:location IS NULL OR location = :location) "</span> +
        <span class="string">"AND (:department IS NULL OR department = :department)"</span>, nativeQuery = <span class="keyword">true</span>)
Double <span class="function">avgApprovalTimeHoursWithFilters</span>(
    <span class="annotation">@Param</span>(<span class="string">"location"</span>) String location,
    <span class="annotation">@Param</span>(<span class="string">"department"</span>) String department,
    <span class="annotation">@Param</span>(<span class="string">"createdAfter"</span>) LocalDateTime createdAfter,
    <span class="annotation">@Param</span>(<span class="string">"createdBefore"</span>) LocalDateTime createdBefore
);
            </div>

            <h3>4.2 Demographic Distribution Queries</h3>
            <div class="code-block">
<span class="comment">// Provider gender distribution</span>
<span class="annotation">@Query</span>(value = <span class="string">"SELECT provider_gender, COUNT(*) FROM timesheets "</span> +
               <span class="string">"WHERE provider_gender IS NOT NULL "</span> +
               <span class="string">"GROUP BY provider_gender ORDER BY provider_gender"</span>, nativeQuery = <span class="keyword">true</span>)
List&lt;Object[]&gt; <span class="function">countByProviderGender</span>();

<span class="comment">// Combined distinct genders (union of provider and recipient)</span>
<span class="annotation">@Query</span>(value = <span class="string">"SELECT DISTINCT provider_gender FROM timesheets WHERE provider_gender IS NOT NULL "</span> +
               <span class="string">"UNION "</span> +
               <span class="string">"SELECT DISTINCT recipient_gender FROM timesheets WHERE recipient_gender IS NOT NULL "</span> +
               <span class="string">"ORDER BY provider_gender"</span>, nativeQuery = <span class="keyword">true</span>)
List&lt;String&gt; <span class="function">findDistinctGenders</span>();
            </div>

            <h3>4.3 Frontend Service Integration</h3>
            <div class="code-block">
<span class="comment">// analytics.service.ts - Frontend API client</span>
<span class="keyword">export class</span> <span class="type">AnalyticsService</span> {
    <span class="keyword">private</span> baseUrl = <span class="string">`${process.env.NEXT_PUBLIC_API_URL}/api/analytics`</span>;
    
    <span class="keyword">async</span> <span class="function">getRealtimeMetrics</span>(token: <span class="type">string</span>, filters: <span class="type">FilterParams</span>) {
        <span class="keyword">const</span> params = <span class="keyword">new</span> URLSearchParams();
        <span class="keyword">if</span> (filters.county) params.append(<span class="string">'county'</span>, filters.county);
        <span class="keyword">if</span> (filters.status) params.append(<span class="string">'status'</span>, filters.status);
        <span class="keyword">if</span> (filters.startYear) params.append(<span class="string">'startYear'</span>, filters.startYear);
        <span class="keyword">if</span> (filters.endYear) params.append(<span class="string">'endYear'</span>, filters.endYear);
        
        <span class="keyword">const</span> response = <span class="keyword">await</span> fetch(
            <span class="string">`${this.baseUrl}/realtime-metrics?${params.toString()}`</span>,
            {
                headers: {
                    <span class="string">'Authorization'</span>: <span class="string">`Bearer ${token}`</span>,
                    <span class="string">'Content-Type'</span>: <span class="string">'application/json'</span>
                }
            }
        );
        
        <span class="keyword">return</span> response.json();
    }
    
    <span class="keyword">async</span> <span class="function">getAdhocData</span>(token: <span class="type">string</span>, filters: <span class="type">AdhocFilters</span>) {
        <span class="keyword">const</span> params = <span class="keyword">new</span> URLSearchParams();
        params.append(<span class="string">'limit'</span>, (filters.limit || <span class="number">200</span>).toString());
        <span class="keyword">if</span> (filters.providerGender) params.append(<span class="string">'providerGender'</span>, filters.providerGender);
        <span class="keyword">if</span> (filters.recipientGender) params.append(<span class="string">'recipientGender'</span>, filters.recipientGender);
        <span class="comment">// ... other filters</span>
        
        <span class="keyword">const</span> response = <span class="keyword">await</span> fetch(
            <span class="string">`${this.baseUrl}/adhoc-data?${params.toString()}`</span>,
            { headers: { <span class="string">'Authorization'</span>: <span class="string">`Bearer ${token}`</span> } }
        );
        
        <span class="keyword">return</span> response.json();
    }
}
            </div>
        </section>

        <!-- Section 5: Security -->
        <section id="security" class="section">
            <h2>üîê 5. Security & Access Control</h2>

            <h3>5.1 JWT Token Structure</h3>
            <div class="code-block">
{
  <span class="string">"sub"</span>: <span class="string">"user123"</span>,
  <span class="string">"realm_access"</span>: {
    <span class="string">"roles"</span>: [<span class="string">"SUPERVISOR"</span>, <span class="string">"offline_access"</span>]
  },
  <span class="string">"resource_access"</span>: {
    <span class="string">"trial-app"</span>: {
      <span class="string">"roles"</span>: [<span class="string">"SUPERVISOR"</span>]
    }
  },
  <span class="string">"countyId"</span>: <span class="string">"Orange"</span>,  <span class="comment">// or in attributes.countyId</span>
  <span class="string">"attributes"</span>: {
    <span class="string">"countyId"</span>: [<span class="string">"Orange"</span>]
  }
}
            </div>

            <h3>5.2 Role-Based Data Access Matrix</h3>
            <div class="table-container">
                <table>
                    <tr>
                        <th>Role</th>
                        <th>County Filter</th>
                        <th>Data Access</th>
                        <th>Filter Override Allowed</th>
                    </tr>
                    <tr>
                        <td>ADMIN</td>
                        <td>Optional</td>
                        <td>All data across all counties</td>
                        <td>Yes</td>
                    </tr>
                    <tr>
                        <td>SYSTEM_SCHEDULER</td>
                        <td>Optional</td>
                        <td>All data (for batch processing)</td>
                        <td>Yes</td>
                    </tr>
                    <tr>
                        <td>SUPERVISOR</td>
                        <td>From JWT Token</td>
                        <td>County-specific data only</td>
                        <td>No</td>
                    </tr>
                    <tr>
                        <td>CASE_WORKER</td>
                        <td>From JWT Token (Required)</td>
                        <td>County-specific data only</td>
                        <td>No</td>
                    </tr>
                    <tr>
                        <td>PROVIDER</td>
                        <td>From JWT Token</td>
                        <td>Own records only</td>
                        <td>No</td>
                    </tr>
                    <tr>
                        <td>RECIPIENT</td>
                        <td>From JWT Token</td>
                        <td>Own records only</td>
                        <td>No</td>
                    </tr>
                </table>
            </div>

            <h3>5.3 JWT Extraction Implementation</h3>
            <div class="code-block">
<span class="keyword">private</span> Map&lt;String, Object&gt; <span class="function">extractUserInfoFromJwt</span>() {
    Map&lt;String, Object&gt; userInfo = <span class="keyword">new</span> HashMap&lt;&gt;();
    <span class="keyword">try</span> {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        <span class="keyword">if</span> (authentication != <span class="keyword">null</span> && authentication.getPrincipal() <span class="keyword">instanceof</span> Jwt) {
            Jwt jwt = (Jwt) authentication.getPrincipal();
            
            <span class="comment">// Priority 1: Extract role from client roles (resource_access.trial-app.roles)</span>
            String extractedRole = <span class="keyword">null</span>;
            Map&lt;String, Object&gt; resourceAccess = jwt.getClaimAsMap(<span class="string">"resource_access"</span>);
            <span class="keyword">if</span> (resourceAccess != <span class="keyword">null</span>) {
                Map&lt;String, Object&gt; trialAppAccess = (Map&lt;String, Object&gt;) resourceAccess.get(<span class="string">"trial-app"</span>);
                <span class="keyword">if</span> (trialAppAccess != <span class="keyword">null</span>) {
                    List&lt;String&gt; clientRoles = (List&lt;String&gt;) trialAppAccess.get(<span class="string">"roles"</span>);
                    <span class="keyword">if</span> (clientRoles != <span class="keyword">null</span> && !clientRoles.isEmpty()) {
                        <span class="keyword">for</span> (String role : clientRoles) {
                            <span class="keyword">if</span> (role != <span class="keyword">null</span> && !role.trim().isEmpty()) {
                                extractedRole = RoleMapper.<span class="function">canonicalName</span>(role);
                                <span class="keyword">break</span>;
                            }
                        }
                    }
                }
            }
            
            <span class="comment">// Priority 2: Fallback to realm roles</span>
            <span class="keyword">if</span> (extractedRole == <span class="keyword">null</span>) {
                Map&lt;String, Object&gt; realmAccess = jwt.getClaimAsMap(<span class="string">"realm_access"</span>);
                <span class="keyword">if</span> (realmAccess != <span class="keyword">null</span>) {
                    List&lt;String&gt; roles = (List&lt;String&gt;) realmAccess.get(<span class="string">"roles"</span>);
                    <span class="keyword">if</span> (roles != <span class="keyword">null</span>) {
                        <span class="keyword">for</span> (String role : roles) {
                            <span class="keyword">if</span> (role != <span class="keyword">null</span> && !role.startsWith(<span class="string">"default-roles-"</span>) &&
                                !role.equals(<span class="string">"offline_access"</span>) && !role.equals(<span class="string">"uma_authorization"</span>)) {
                                extractedRole = RoleMapper.<span class="function">canonicalName</span>(role);
                                <span class="keyword">break</span>;
                            }
                        }
                    }
                }
            }
            
            <span class="keyword">if</span> (extractedRole != <span class="keyword">null</span>) {
                userInfo.put(<span class="string">"role"</span>, extractedRole);
            }
            
            <span class="comment">// Extract countyId from JWT attributes</span>
            String countyId = jwt.getClaimAsString(<span class="string">"countyId"</span>);
            <span class="keyword">if</span> (countyId == <span class="keyword">null</span> || countyId.trim().isEmpty()) {
                Map&lt;String, Object&gt; attributes = jwt.getClaimAsMap(<span class="string">"attributes"</span>);
                <span class="keyword">if</span> (attributes != <span class="keyword">null</span>) {
                    Object countyIdObj = attributes.get(<span class="string">"countyId"</span>);
                    <span class="keyword">if</span> (countyIdObj <span class="keyword">instanceof</span> List && ((List&lt;?&gt;) countyIdObj).size() > <span class="number">0</span>) {
                        countyId = ((List&lt;?&gt;) countyIdObj).get(<span class="number">0</span>).toString();
                    } <span class="keyword">else if</span> (countyIdObj != <span class="keyword">null</span>) {
                        countyId = countyIdObj.toString();
                    }
                }
            }
            
            <span class="keyword">if</span> (countyId != <span class="keyword">null</span> && !countyId.trim().isEmpty()) {
                userInfo.put(<span class="string">"countyId"</span>, countyId);
            }
        }
    } <span class="keyword">catch</span> (Exception e) {
        log.error(<span class="string">"Error extracting user info from JWT"</span>, e);
    }
    <span class="keyword">return</span> userInfo;
}
            </div>
        </section>

        <!-- Section 6: Performance -->
        <section id="performance" class="section">
            <h2>‚ö° 6. Performance Optimization</h2>

            <h3>6.1 Query Optimization Techniques</h3>
            <div class="grid-2">
                <div class="card">
                    <h4>üéØ Indexed Columns</h4>
                    <ul>
                        <li><code>location</code> - County filtering</li>
                        <li><code>status</code> - Status filtering</li>
                        <li><code>created_at</code> - Date range queries</li>
                        <li><code>employee_id</code> - Distinct counts</li>
                    </ul>
                </div>
                <div class="card">
                    <h4>üìä Pagination Strategy</h4>
                    <ul>
                        <li>Default limit: 200 records</li>
                        <li>Maximum limit: 1000 records</li>
                        <li>Uses LIMIT/OFFSET in native queries</li>
                        <li>Returns total count separately</li>
                    </ul>
                </div>
            </div>

            <h3>6.2 Memory Management</h3>
            <div class="warning-box">
                <strong>‚ö†Ô∏è Important:</strong> All data queries use pagination to prevent OutOfMemoryError. Never use <code>findAll()</code> for large tables.
            </div>

            <div class="code-block">
<span class="comment">// GOOD: Paginated query with safety limit</span>
<span class="annotation">@Query</span>(value = <span class="string">"SELECT * FROM timesheets WHERE location = :location "</span> +
               <span class="string">"ORDER BY created_at DESC LIMIT :pageSize OFFSET :offset"</span>, nativeQuery = <span class="keyword">true</span>)
List&lt;TimesheetEntity&gt; <span class="function">findByLocationWithPagination</span>(
    <span class="annotation">@Param</span>(<span class="string">"location"</span>) String location,
    <span class="annotation">@Param</span>(<span class="string">"offset"</span>) <span class="keyword">int</span> offset,
    <span class="annotation">@Param</span>(<span class="string">"pageSize"</span>) <span class="keyword">int</span> pageSize
);

<span class="comment">// GOOD: Limited query for stats calculation (max 10,000 records)</span>
<span class="keyword">if</span> (countyFilter != <span class="keyword">null</span>) {
    timesheets = timesheetRepository.<span class="function">findByLocationWithPagination</span>(countyFilter, <span class="number">0</span>, <span class="number">10000</span>);
} <span class="keyword">else</span> {
    timesheets = timesheetRepository.<span class="function">findMostRecentWithLimit</span>(<span class="number">10000</span>);
}

<span class="comment">// BAD: Never do this!</span>
<span class="comment">// timesheets = timesheetRepository.findAll(); // Can cause OutOfMemoryError</span>
            </div>

            <h3>6.3 Caching Recommendations</h3>
            <div class="success-box">
                <strong>‚úÖ Cacheable Data:</strong> Filter options (distinct locations, departments, statuses) change infrequently and can be cached with a TTL of 5-15 minutes.
            </div>
        </section>

        <!-- Section 7: Frontend -->
        <section id="frontend" class="section">
            <h2>üñ•Ô∏è 7. Frontend Integration</h2>

            <h3>7.1 Analytics Page Structure</h3>
            <p>The frontend analytics page (<code>app/analytics/page.tsx</code>) uses React hooks and Chart.js for visualization:</p>

            <div class="code-block">
<span class="comment">// Component structure</span>
<span class="keyword">export default function</span> <span class="function">AnalyticsPage</span>() {
    <span class="keyword">const</span> { token } = <span class="function">useAuth</span>();
    <span class="keyword">const</span> [metrics, setMetrics] = <span class="function">useState</span>&lt;<span class="type">RealtimeMetrics</span> | <span class="keyword">null</span>&gt;(<span class="keyword">null</span>);
    <span class="keyword">const</span> [filters, setFilters] = <span class="function">useState</span>&lt;<span class="type">FilterParams</span>&gt;({});
    <span class="keyword">const</span> [filterOptions, setFilterOptions] = <span class="function">useState</span>&lt;<span class="type">FilterOptions</span>&gt;({});
    
    <span class="comment">// Load filter options on mount</span>
    <span class="function">useEffect</span>(() =&gt; {
        <span class="keyword">async function</span> <span class="function">loadFilterOptions</span>() {
            <span class="keyword">const</span> options = <span class="keyword">await</span> analyticsService.<span class="function">getFilterOptions</span>(token);
            <span class="function">setFilterOptions</span>(options);
        }
        <span class="function">loadFilterOptions</span>();
    }, [token]);
    
    <span class="comment">// Load metrics when filters change</span>
    <span class="function">useEffect</span>(() =&gt; {
        <span class="keyword">async function</span> <span class="function">loadMetrics</span>() {
            <span class="keyword">const</span> data = <span class="keyword">await</span> analyticsService.<span class="function">getRealtimeMetrics</span>(token, filters);
            <span class="function">setMetrics</span>(data);
        }
        <span class="function">loadMetrics</span>();
    }, [token, filters]);
    
    <span class="keyword">return</span> (
        &lt;div className={styles.container}&gt;
            &lt;FilterPanel options={filterOptions} onChange={setFilters} /&gt;
            &lt;MetricsCards metrics={metrics} /&gt;
            &lt;DemographicsCharts data={metrics} /&gt;
            &lt;AdhocDataTable filters={filters} /&gt;
        &lt;/div&gt;
    );
}
            </div>

            <h3>7.2 Chart.js Integration</h3>
            <div class="code-block">
<span class="comment">// Gender distribution chart</span>
<span class="keyword">const</span> genderChartData = {
    labels: Object.keys(demographics.provider),
    datasets: [
        {
            label: <span class="string">'Providers'</span>,
            data: Object.values(demographics.provider),
            backgroundColor: [<span class="string">'rgba(54, 162, 235, 0.8)'</span>, <span class="string">'rgba(255, 99, 132, 0.8)'</span>]
        },
        {
            label: <span class="string">'Recipients'</span>,
            data: Object.values(demographics.recipient),
            backgroundColor: [<span class="string">'rgba(54, 162, 235, 0.5)'</span>, <span class="string">'rgba(255, 99, 132, 0.5)'</span>]
        }
    ]
};

&lt;Bar 
    data={genderChartData}
    options={{
        responsive: <span class="keyword">true</span>,
        plugins: { legend: { position: <span class="string">'top'</span> } },
        scales: { y: { beginAtZero: <span class="keyword">true</span> } }
    }}
/&gt;
            </div>
        </section>

        <!-- Section 8: FAQ -->
        <section id="faq" class="section">
            <h2>‚ùì 8. FAQ & Troubleshooting</h2>

            <h3>Q: Why do I get different data than expected for my county?</h3>
            <div class="highlight-box">
                <p><strong>A:</strong> The county filter is enforced from your JWT token, not the dropdown selection. Check that your Keycloak user has the correct <code>countyId</code> attribute. The dropdown selection is overridden by the token for restricted roles (SUPERVISOR, CASE_WORKER, PROVIDER, RECIPIENT).</p>
            </div>

            <h3>Q: How do I add a new analytics metric?</h3>
            <div class="highlight-box">
                <ol>
                    <li>Add a new query method to <code>TimesheetRepository.java</code> with proper parameter handling</li>
                    <li>Create or modify an endpoint in <code>AnalyticsController.java</code></li>
                    <li>Add the corresponding method to <code>analytics.service.ts</code></li>
                    <li>Update the frontend component to display the new metric</li>
                </ol>
            </div>

            <h3>Q: Why are some demographic fields showing as null?</h3>
            <div class="highlight-box">
                <p><strong>A:</strong> Demographic fields (<code>providerGender</code>, <code>providerEthnicity</code>, etc.) are optional in the database schema. The queries filter out NULL values using <code>WHERE provider_gender IS NOT NULL</code>. If you're seeing unexpected nulls, verify the data was properly populated during timesheet creation.</p>
            </div>

            <h3>Q: How can I improve query performance?</h3>
            <div class="highlight-box">
                <ul>
                    <li>Ensure indexes exist on <code>location</code>, <code>status</code>, <code>created_at</code></li>
                    <li>Use date range filters to limit result sets</li>
                    <li>Consider adding composite indexes for frequently combined filters</li>
                    <li>Use EXPLAIN ANALYZE in PostgreSQL to identify slow queries</li>
                </ul>
            </div>
        </section>

        <!-- Footer -->
        <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
            <p>Deep Dive Analytics Documentation | IHSS/CMIPS Timesheet Management System</p>
            <p>Generated: December 8, 2025</p>
        </div>
    </div>
</body>
</html>

