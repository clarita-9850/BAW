<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau Analytics Dashboard - Timesheet Analytics</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" referrerpolicy="no-referrer" />
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
            min-height: 100vh;
        }

        .dashboard-container {
            max-width: 100%;
            margin: 0;
            padding: 20px;
        }

        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .dashboard-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .dashboard-header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .filters-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: flex-end;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 220px;
        }

        .filter-group label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #555;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.6px;
        }

        .filter-group select {
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #dcdcdc;
            font-size: 0.95rem;
            background: #fafafa;
        }

        .filter-inline {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
        }

        .filter-separator {
            color: #888;
            font-weight: 600;
        }

        .filter-reset {
            background: #f1f3fa;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            color: #4a4a68;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .filter-reset:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 76, 114, 0.15);
        }

        .active-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 25px;
        }

        .filter-chip {
            background: #eef2ff;
            color: #4c51bf;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-chip i {
            font-size: 0.85rem;
        }

        .metric-card {
            background: white;
            padding: 20px 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #667eea;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            gap: 20px;
            min-height: 120px;
        }

        .metric-icon {
            width: 64px;
            height: 64px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(102, 126, 234, 0.15);
            color: #4c51bf;
            font-size: 2rem;
            flex-shrink: 0;
            box-shadow: inset 0 0 0 2px rgba(102, 126, 234, 0.25);
        }

        .metric-details {
            flex: 1;
            overflow: hidden;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .metric-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #1a202c;
            margin-bottom: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .metric-change {
            font-size: 0.85rem;
            color: #28a745;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .metric-value.monetary {
            font-size: clamp(1.2rem, 2vw, 1.8rem);
            font-weight: 700;
            color: #0c4a6e;
            display: flex;
            align-items: baseline;
            flex-wrap: wrap;
            gap: 6px;
            max-width: 100%;
        }

        .metric-value.monetary .currency {
            font-size: 1rem;
            color: #475569;
            font-weight: 600;
            letter-spacing: 0.4px;
            flex-shrink: 0;
        }

        .metric-value.monetary .amount {
            font-size: inherit;
            font-weight: inherit;
            color: inherit;
            min-width: 0;
            overflow: visible;
            text-overflow: unset;
            word-break: break-word;
        }

        .analytics-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .section-header {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            height: 400px;
            position: relative;
        }

        .chart-container canvas {
            max-height: 350px;
            width: 100% !important;
            height: 100% !important;
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-title i {
            color: #667eea;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin-bottom: 20px;
            transition: background 0.3s;
        }

        .refresh-btn:hover {
            background: #5568d3;
        }

        .refresh-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .stats-table th,
        .stats-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .stats-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .stats-table tr:hover {
            background: #f8f9fa;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            .metrics-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        const TableauAnalyticsDashboard = () => {
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [realtimeMetrics, setRealtimeMetrics] = useState(null);
            const [genderData, setGenderData] = useState(null);
            const [ethnicityData, setEthnicityData] = useState(null);
            const [ageData, setAgeData] = useState(null);
            const [yearData, setYearData] = useState(null);
            const [countyMemberData, setCountyMemberData] = useState([]);
            const [countyMemberTotal, setCountyMemberTotal] = useState(0);
            const [countyProviderTotal, setCountyProviderTotal] = useState(0);
            const [countyRecipientTotal, setCountyRecipientTotal] = useState(0);
            const [activeTab, setActiveTab] = useState('overview');
            const [dataScope, setDataScope] = useState('combined');
            const [availableYears, setAvailableYears] = useState([]);
            const [allYears, setAllYears] = useState([]);
            const [selectedStartYear, setSelectedStartYear] = useState(null);
            const [selectedEndYear, setSelectedEndYear] = useState(null);
            const [filterOptions, setFilterOptions] = useState(null);
            const [filtersLoading, setFiltersLoading] = useState(true);
            const [filtersError, setFiltersError] = useState(null);
            const [selectedDistrict, setSelectedDistrict] = useState('all');
            const [selectedCounty, setSelectedCounty] = useState('all');
            const [selectedStatus, setSelectedStatus] = useState('all');
            const [selectedPriorityLevel, setSelectedPriorityLevel] = useState('all');

            const genderChartRef = useRef(null);
            const ethnicityChartRef = useRef(null);
            const ageChartRef = useRef(null);
            const yearChartRef = useRef(null);
            const countyChartRef = useRef(null);

            const API_BASE = 'http://localhost:8080/api/analytics';

            const normalizeFilter = (value) => {
                if (value === undefined || value === null) return null;
                if (typeof value === 'string' && value.toLowerCase() === 'all') return null;
                if (typeof value === 'string' && value.trim() === '') return null;
                return typeof value === 'string' ? value.trim() : value;
            };

            const handleDataScopeChange = (event) => {
                setDataScope(event.target.value);
            };

            const handleStartYearChange = (event) => {
                const newStart = event.target.value;
                setSelectedStartYear(newStart);
                if (selectedEndYear && parseInt(newStart, 10) > parseInt(selectedEndYear, 10)) {
                    setSelectedEndYear(newStart);
                }
            };

            const handleEndYearChange = (event) => {
                const newEnd = event.target.value;
                setSelectedEndYear(newEnd);
                if (selectedStartYear && parseInt(newEnd, 10) < parseInt(selectedStartYear, 10)) {
                    setSelectedStartYear(newEnd);
                }
            };

            const resetFilters = () => {
                setDataScope('combined');
                setSelectedDistrict('all');
                setSelectedCounty('all');
                setSelectedStatus('all');
                setSelectedPriorityLevel('all');
                setSelectedStartYear('');
                setSelectedEndYear('');
            };

            useEffect(() => {
                const options = yearOptions;
                if (!options.length) {
                    return;
                }

                setSelectedStartYear(prev => {
                if (prev === '') {
                    return '';
                }
                if (prev === null) {
                    return '';
                }
                if (!availableYears.includes(prev)) {
                        return availableYears[0];
                    }
                    return prev;
                });

                setSelectedEndYear(prev => {
                    if (prev === '') {
                        return '';
                    }
                    if (prev === null) {
                        return '';
                    }
                    if (!options.includes(prev)) {
                        return options[options.length - 1];
                    }
                    return prev;
                });
            }, [yearOptions]);

            const fetchFilterOptions = useCallback(async () => {
                setFiltersLoading(true);
                setFiltersError(null);
                try {
                    const response = await fetch(`${API_BASE}/filters`);
                    if (!response.ok) {
                        throw new Error('Failed to fetch filter metadata');
                    }
                    const data = await response.json();
                    if (data.status && data.status !== 'SUCCESS') {
                        throw new Error(data.message || 'Failed to load filter options');
                    }
                    setFilterOptions(data);
                } catch (err) {
                    console.error('Failed to load filter options', err);
                    setFiltersError(err.message);
                } finally {
                    setFiltersLoading(false);
                }
            }, []);

            useEffect(() => {
                if (!selectedStartYear || !selectedEndYear) {
                    return;
                }

                const startNum = parseInt(selectedStartYear, 10);
                const endNum = parseInt(selectedEndYear, 10);

                if (!Number.isNaN(startNum) && !Number.isNaN(endNum) && startNum > endNum) {
                    setSelectedEndYear(selectedStartYear);
                }
            }, [selectedStartYear, selectedEndYear]);

            const fetchData = useCallback(async () => {
                setLoading(true);
                setError(null);
                try {
                const params = new URLSearchParams();
                    const districtParam = normalizeFilter(selectedDistrict);
                    const countyParam = normalizeFilter(selectedCounty);
                    const statusParam = normalizeFilter(selectedStatus);
                    const priorityParam = normalizeFilter(selectedPriorityLevel);
                    if (districtParam) params.append('districtId', districtParam);
                    if (countyParam) params.append('county', countyParam);
                    if (statusParam) params.append('status', statusParam);
                    if (priorityParam) params.append('priorityLevel', priorityParam);
                    if (selectedStartYear && selectedStartYear !== '') params.append('startYear', selectedStartYear);
                    if (selectedEndYear && selectedEndYear !== '') params.append('endYear', selectedEndYear);
                    
                    const paramString = params.toString();
                    const querySuffix = paramString ? `?${paramString}` : '';
                    
                    // Fetch all analytics data in parallel
                    const [realtimeRes, genderRes, ethnicityRes, ageRes, yearRes, countyRes] = await Promise.all([
                        fetch(`${API_BASE}/realtime-metrics${querySuffix}`),
                        fetch(`${API_BASE}/demographics/gender${querySuffix}`),
                        fetch(`${API_BASE}/demographics/ethnicity${querySuffix}`),
                        fetch(`${API_BASE}/demographics/age${querySuffix}`),
                        fetch(`${API_BASE}/timesheets-by-year${querySuffix}`),
                        fetch(`${API_BASE}/county-member-counts${querySuffix}`)
                    ]);

                    if (!realtimeRes.ok) throw new Error('Failed to fetch realtime metrics');
                    if (!genderRes.ok) throw new Error('Failed to fetch gender data');
                    if (!ethnicityRes.ok) throw new Error('Failed to fetch ethnicity data');
                    if (!ageRes.ok) throw new Error('Failed to fetch age data');
                    if (!yearRes.ok) throw new Error('Failed to fetch year data');
                    if (!countyRes.ok) throw new Error('Failed to fetch county member data');

                    setRealtimeMetrics(await realtimeRes.json());
                    setGenderData(await genderRes.json());
                    setEthnicityData(await ethnicityRes.json());
                    setAgeData(await ageRes.json());
                    const yearResponse = await yearRes.json();
                    const yearPayload = yearResponse.data || {};
                    setYearData(yearPayload);
                    const yearKeys = Object.keys(yearPayload).sort((a, b) => Number(a) - Number(b));
                    setAvailableYears(yearKeys);
                    if (!selectedStartYear && !selectedEndYear && yearKeys.length) {
                        setAllYears(yearKeys);
                    }

                    const countyResponse = await countyRes.json();
                    const countyPayload = countyResponse.counties || [];
                    setCountyMemberData(countyPayload);
                    setCountyMemberTotal(countyResponse.totalMembers || 0);
                    setCountyProviderTotal(countyResponse.totalProviders || 0);
                    setCountyRecipientTotal(countyResponse.totalRecipients || 0);
                } catch (err) {
                    setError(err.message);
                    console.error('Error fetching data:', err);
                } finally {
                    setLoading(false);
                }
            }, [
                selectedDistrict,
                selectedCounty,
                selectedStatus,
                selectedPriorityLevel,
                selectedStartYear,
                selectedEndYear
            ]);

            useEffect(() => {
                fetchFilterOptions();
            }, [fetchFilterOptions]);

            useEffect(() => {
                fetchData();
                const interval = setInterval(fetchData, 30000); // Refresh every 30 seconds
                return () => clearInterval(interval);
            }, [fetchData]);

            // Render charts when data is loaded, tab is active, and canvas is mounted
            useEffect(() => {
                if (!loading && genderData && (activeTab === 'overview' || activeTab === 'demographics')) {
                    // Wait for canvas to be mounted, especially when switching tabs
                    const timer = setTimeout(() => {
                        if (genderChartRef.current) {
                            renderGenderChart();
                        } else {
                            console.log('Gender chart ref not available yet');
                        }
                    }, 300);
                    return () => clearTimeout(timer);
                }
            }, [genderData, loading, activeTab, dataScope]);

            useEffect(() => {
                if (!loading && ethnicityData && activeTab === 'demographics') {
                    const timer = setTimeout(() => {
                        if (ethnicityChartRef.current) {
                            renderEthnicityChart();
                        } else {
                            console.log('Ethnicity chart ref not available yet');
                        }
                    }, 300);
                    return () => clearTimeout(timer);
                }
            }, [ethnicityData, loading, activeTab, dataScope]);

            useEffect(() => {
                if (!loading && ageData && (activeTab === 'demographics' || activeTab === 'trends')) {
                    const timer = setTimeout(() => {
                        if (ageChartRef.current) {
                            renderAgeChart();
                        } else {
                            console.log('Age chart ref not available yet');
                        }
                    }, 300);
                    return () => clearTimeout(timer);
                }
            }, [ageData, loading, activeTab, dataScope]);

            useEffect(() => {
                if (!loading && countyMemberData && countyMemberData.length && activeTab === 'overview') {
                    const timer = setTimeout(() => {
                        if (countyChartRef.current) {
                            renderCountyChart();
                        }
                    }, 300);
                    return () => clearTimeout(timer);
                }
            }, [countyMemberData, loading, activeTab]);

            useEffect(() => {
                if (!loading && yearData && (activeTab === 'overview' || activeTab === 'trends')) {
                    const timer = setTimeout(() => {
                        if (yearChartRef.current) {
                            renderYearChart();
                        } else {
                            console.log('Year chart ref not available yet');
                        }
                    }, 300);
                    return () => clearTimeout(timer);
                }
            }, [yearData, loading, activeTab, selectedStartYear, selectedEndYear]);

            const renderGenderChart = () => {
                if (!genderData || !genderChartRef.current) {
                    console.log('Gender chart: Missing data or ref', { genderData: !!genderData, ref: !!genderChartRef.current });
                    return;
                }

                try {
                    const ctx = genderChartRef.current.getContext('2d');
                    if (!ctx) {
                        console.error('Failed to get 2d context');
                        return;
                    }
                    
                    // Destroy existing chart if it exists
                    if (genderChartRef.current.chart) {
                        genderChartRef.current.chart.destroy();
                    }

                    const providerData = genderData.provider || {};
                    const recipientData = genderData.recipient || {};
                    const allLabels = Array.from(new Set([
                        ...Object.keys(providerData),
                        ...Object.keys(recipientData)
                    ])).sort();

                    if (!allLabels.length) {
                        console.warn('Gender chart: No categories available');
                        return;
                    }

                    const scopeLabelMap = {
                        combined: 'Providers & Recipients',
                        providers: 'Providers',
                        recipients: 'Recipients'
                    };

                    let datasets = [];

                    if (dataScope === 'providers') {
                        datasets = [
                            {
                                label: 'Providers',
                                data: allLabels.map(label => providerData[label] || 0),
                                backgroundColor: 'rgba(102, 126, 234, 0.8)',
                                borderColor: 'rgba(102, 126, 234, 1)',
                                borderWidth: 1
                            }
                        ];
                    } else if (dataScope === 'recipients') {
                        datasets = [
                            {
                                label: 'Recipients',
                                data: allLabels.map(label => recipientData[label] || 0),
                                backgroundColor: 'rgba(118, 75, 162, 0.8)',
                                borderColor: 'rgba(118, 75, 162, 1)',
                                borderWidth: 1
                            }
                        ];
                    } else {
                        datasets = [
                            {
                                label: 'Providers',
                                data: allLabels.map(label => providerData[label] || 0),
                                backgroundColor: 'rgba(102, 126, 234, 0.8)',
                                borderColor: 'rgba(102, 126, 234, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Recipients',
                                data: allLabels.map(label => recipientData[label] || 0),
                                backgroundColor: 'rgba(118, 75, 162, 0.8)',
                                borderColor: 'rgba(118, 75, 162, 1)',
                                borderWidth: 1
                            }
                        ];
                    }

                    genderChartRef.current.chart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: allLabels,
                            datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                    display: true
                                },
                                title: {
                                    display: true,
                                    text: `Gender Distribution (${scopeLabelMap[dataScope] || 'All'})`
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error('Error rendering gender chart:', error);
                }
            };

            const renderEthnicityChart = () => {
                if (!ethnicityData || !ethnicityChartRef.current) {
                    console.log('Ethnicity chart: Missing data or ref', { ethnicityData: !!ethnicityData, ref: !!ethnicityChartRef.current });
                    return;
                }

                try {
                    const ctx = ethnicityChartRef.current.getContext('2d');
                    if (!ctx) {
                        console.error('Failed to get 2d context');
                        return;
                    }
                    
                    if (ethnicityChartRef.current.chart) {
                        ethnicityChartRef.current.chart.destroy();
                    }

                    const providerData = ethnicityData.provider || {};
                    const recipientData = ethnicityData.recipient || {};
                    const allLabels = Array.from(new Set([
                        ...Object.keys(providerData),
                        ...Object.keys(recipientData)
                    ])).sort();

                    if (!allLabels.length) {
                        console.warn('Ethnicity chart: No categories available');
                        return;
                    }

                    const colorPalette = [
                        'rgba(102, 126, 234, 0.8)',
                        'rgba(118, 75, 162, 0.8)',
                        'rgba(255, 99, 132, 0.8)',
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(255, 206, 86, 0.8)',
                        'rgba(75, 192, 192, 0.8)',
                        'rgba(153, 102, 255, 0.8)',
                        'rgba(255, 159, 64, 0.8)',
                        'rgba(199, 199, 199, 0.8)'
                    ];

                    const scopeLabelMap = {
                        combined: 'Providers & Recipients',
                        providers: 'Providers',
                        recipients: 'Recipients'
                    };

                    let datasetLabel = 'Providers';
                    let datasetValues = allLabels.map(label => providerData[label] || 0);

                    if (dataScope === 'recipients') {
                        datasetLabel = 'Recipients';
                        datasetValues = allLabels.map(label => recipientData[label] || 0);
                    } else if (dataScope === 'combined') {
                        datasetLabel = 'All (Providers + Recipients)';
                        datasetValues = allLabels.map(label => (providerData[label] || 0) + (recipientData[label] || 0));
                    }

                    ethnicityChartRef.current.chart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: allLabels,
                            datasets: [{
                                label: datasetLabel,
                                data: datasetValues,
                                backgroundColor: colorPalette,
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'right',
                                },
                                title: {
                                    display: true,
                                    text: `Ethnicity Distribution (${scopeLabelMap[dataScope] || 'All'})`
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error('Error rendering ethnicity chart:', error);
                }
            };

            const renderAgeChart = () => {
                if (!ageData || !ageChartRef.current) {
                    console.log('Age chart: Missing data or ref', { ageData: !!ageData, ref: !!ageChartRef.current });
                    return;
                }

                try {
                    const ctx = ageChartRef.current.getContext('2d');
                    if (!ctx) {
                        console.error('Failed to get 2d context');
                        return;
                    }
                    
                    if (ageChartRef.current.chart) {
                        ageChartRef.current.chart.destroy();
                    }

                    const providerData = ageData.provider || {};
                    const recipientData = ageData.recipient || {};
                    const labels = Object.keys({...providerData, ...recipientData}).sort();

                    ageChartRef.current.chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                            {
                                label: 'Providers',
                                data: labels.map(label => providerData[label] || 0),
                                borderColor: 'rgba(102, 126, 234, 1)',
                                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Recipients',
                                data: labels.map(label => recipientData[label] || 0),
                                borderColor: 'rgba(118, 75, 162, 1)',
                                backgroundColor: 'rgba(118, 75, 162, 0.1)',
                                tension: 0.4,
                                fill: true
                            }
                        ]
                    },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                },
                                title: {
                                    display: true,
                                    text: 'Age Group Distribution'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error('Error rendering age chart:', error);
                }
            };

            const renderCountyChart = () => {
                if (!countyMemberData || !countyMemberData.length || !countyChartRef.current) {
                    console.log('County chart: Missing data or ref', { countyData: countyMemberData?.length, ref: !!countyChartRef.current });
                    return;
                }

                try {
                    const ctx = countyChartRef.current.getContext('2d');
                    if (!ctx) {
                        console.error('County chart: failed to get 2d context');
                        return;
                    }

                    if (countyChartRef.current.chart) {
                        countyChartRef.current.chart.destroy();
                    }

                    const labels = countyMemberData.map(item => item.county);
                    const providerCounts = countyMemberData.map(item => item.providerCount || 0);
                    const recipientCounts = countyMemberData.map(item => item.recipientCount || 0);

                    countyChartRef.current.chart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels,
                            datasets: [
                                {
                                    label: 'Providers',
                                    data: providerCounts,
                                    backgroundColor: 'rgba(102, 126, 234, 0.8)',
                                    borderColor: 'rgba(102, 126, 234, 1)',
                                    borderWidth: 1
                                },
                                {
                                    label: 'Recipients',
                                    data: recipientCounts,
                                    backgroundColor: 'rgba(118, 75, 162, 0.8)',
                                    borderColor: 'rgba(118, 75, 162, 1)',
                                    borderWidth: 1
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            indexAxis: 'y',
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top'
                                },
                                title: {
                                    display: true,
                                    text: 'Members by County (Providers vs Recipients)'
                                },
                                tooltip: {
                                    callbacks: {
                                        label: (ctx) => {
                                            const label = ctx.dataset.label || '';
                                            const value = ctx.parsed.x.toLocaleString();
                                            return `${label}: ${value}`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    beginAtZero: true,
                                    ticks: {
                                        precision: 0
                                    },
                                    stacked: false
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error('Error rendering county chart:', error);
                }
            };

            const renderYearChart = () => {
                if (!yearData || !yearChartRef.current) {
                    console.log('Year chart: Missing data or ref', { yearData: !!yearData, ref: !!yearChartRef.current });
                    return;
                }

                try {
                    const ctx = yearChartRef.current.getContext('2d');
                    if (!ctx) {
                        console.error('Failed to get 2d context');
                        return;
                    }
                    
                    if (yearChartRef.current.chart) {
                        yearChartRef.current.chart.destroy();
                    }

                    const labels = Object.keys(yearData).sort();
                    const data = labels.map(year => yearData[year]);

                    yearChartRef.current.chart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                            label: 'Timesheets',
                            data: data,
                            backgroundColor: 'rgba(102, 126, 234, 0.8)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                title: {
                                    display: true,
                                    text: 'Timesheet Counts by Year'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error('Error rendering year chart:', error);
                }
            };

            const yearOptions = allYears.length ? allYears : availableYears;
            const activeFilterChips = [];
            if (normalizeFilter(selectedDistrict)) {
                const districtName = filterOptions?.districts?.find(d => d.id === selectedDistrict)?.name || selectedDistrict;
                activeFilterChips.push({ icon: 'fa-city', label: 'District', value: districtName });
            }
            if (normalizeFilter(selectedCounty)) {
                activeFilterChips.push({ icon: 'fa-map-marker-alt', label: 'County', value: selectedCounty });
            }
            if (normalizeFilter(selectedStatus)) {
                activeFilterChips.push({ icon: 'fa-clipboard-check', label: 'Status', value: selectedStatus });
            }
            if (normalizeFilter(selectedPriorityLevel)) {
                activeFilterChips.push({ icon: 'fa-flag', label: 'Priority', value: selectedPriorityLevel });
            }
            const hasStartYear = selectedStartYear && selectedStartYear !== '';
            const hasEndYear = selectedEndYear && selectedEndYear !== '';
            if (hasStartYear || hasEndYear) {
                if (hasStartYear && hasEndYear && selectedStartYear === selectedEndYear) {
                    activeFilterChips.push({ icon: 'fa-calendar-alt', label: 'Year', value: `${selectedStartYear}` });
                } else {
                    const startLabel = hasStartYear ? selectedStartYear : 'Earliest';
                    const endLabel = hasEndYear ? selectedEndYear : 'Latest';
                    activeFilterChips.push({ icon: 'fa-calendar-alt', label: 'Years', value: `${startLabel} - ${endLabel}` });
                }
            }

            if (loading && !realtimeMetrics) {
                return (
                    <div className="dashboard-container">
                        <div className="loading">Loading dashboard data...</div>
                    </div>
                );
            }

            return (
                <div className="dashboard-container">
                    <div className="dashboard-header">
                        <h1>ðŸ“Š Tableau Analytics Dashboard</h1>
                        <p>Comprehensive Timesheet Analytics & Demographic Insights</p>
                        <button className="refresh-btn" onClick={fetchData} disabled={loading}>
                            {loading ? 'Refreshing...' : 'ðŸ”„ Refresh Data'}
                        </button>
                    </div>

                    {error && <div className="error">Error: {error}</div>}

                    {/* Key Metrics Cards */}
            <div className="metrics-grid">
                        <div className="metric-card">
                            <div className="metric-icon"><i className="fa-solid fa-clipboard-list"></i></div>
                            <div className="metric-details">
                                <div className="metric-label">Total Timesheets Today</div>
                                <div className="metric-value">
                                    {new Intl.NumberFormat().format(realtimeMetrics?.totalTimesheetsToday || 0)}
                                </div>
                                <div className="metric-change">â†‘ Today <i className="fa-solid fa-arrow-trend-up"></i></div>
                            </div>
                        </div>
                        <div className="metric-card">
                            <div className="metric-icon"><i className="fa-solid fa-stopwatch"></i></div>
                            <div className="metric-details">
                                <div className="metric-label">Pending Approvals</div>
                                <div className="metric-value">
                                    {new Intl.NumberFormat().format(realtimeMetrics?.pendingApprovals || 0)}
                                </div>
                                <div className="metric-change">Requires attention <i className="fa-solid fa-triangle-exclamation"></i></div>
                            </div>
                        </div>
                        <div className="metric-card">
                            <div className="metric-icon"><i className="fa-solid fa-people-group"></i></div>
                            <div className="metric-details">
                                <div className="metric-label">Active Participants</div>
                                <div className="metric-value">
                                    {new Intl.NumberFormat().format(realtimeMetrics?.totalParticipants || 0)}
                                </div>
                                <div className="metric-change">Providers: {new Intl.NumberFormat().format(realtimeMetrics?.distinctProviders || 0)} Â· Recipients: {new Intl.NumberFormat().format(realtimeMetrics?.distinctRecipients || 0)}</div>
                            </div>
                        </div>
                        <div className="metric-card">
                            <div className="metric-icon"><i className="fa-solid fa-sack-dollar"></i></div>
                            <div className="metric-details">
                                <div className="metric-label">Approved Amount Today</div>
                                <div className="metric-value monetary">
                                    <span className="currency">USD</span>
                                    <span className="amount">
                                        {new Intl.NumberFormat(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(realtimeMetrics?.totalApprovedAmountToday || 0)}
                                    </span>
                                </div>
                                <div className="metric-change">Revenue <i className="fa-solid fa-chart-column"></i></div>
                            </div>
                        </div>
                        <div className="metric-card">
                            <div className="metric-icon"><i className="fa-solid fa-gauge-high"></i></div>
                            <div className="metric-details">
                                <div className="metric-label">Avg Approval Time</div>
                                <div className="metric-value">
                                    {new Intl.NumberFormat(undefined, { maximumFractionDigits: 1 }).format(realtimeMetrics?.avgApprovalTimeHours || 0)}<span>hrs</span>
                                </div>
                                <div className="metric-change">Average processing <i className="fa-solid fa-arrows-rotate"></i></div>
                            </div>
                        </div>
                        <div className="metric-card">
                            <div className="metric-icon"><i className="fa-solid fa-calendar-check"></i></div>
                            <div className="metric-details">
                                <div className="metric-label">Approved This Week</div>
                                <div className="metric-value monetary">
                                    <span className="currency">USD</span>
                                    <span className="amount">
                                        {new Intl.NumberFormat(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(realtimeMetrics?.totalApprovedAmountThisWeek || 0)}
                                    </span>
                                </div>
                                <div className="metric-change">Weekly revenue <i className="fa-solid fa-wave-square"></i></div>
                            </div>
                        </div>
                    </div>

                    {/* Filters Panel */}
                    <div className="filters-panel">
                        <div className="filter-group">
                        <label htmlFor="dataScopeSelect"><i className="fa-solid fa-layer-group"></i>Data Scope</label>
                            <select
                                id="dataScopeSelect"
                                value={dataScope}
                                onChange={handleDataScopeChange}
                            >
                                <option value="combined">Providers &amp; Recipients</option>
                                <option value="providers">Providers</option>
                                <option value="recipients">Recipients</option>
                            </select>
                        </div>

                        <div className="filter-group">
                            <label htmlFor="districtSelect"><i className="fa-solid fa-city"></i>District</label>
                            <select
                                id="districtSelect"
                                value={selectedDistrict}
                                onChange={(e) => setSelectedDistrict(e.target.value)}
                                disabled={filtersLoading}
                            >
                                <option value="all">All Districts</option>
                                {(filterOptions?.districts || []).map((district) => (
                                    <option key={district.id} value={district.id}>
                                        {district.name}
                                    </option>
                                ))}
                            </select>
                        </div>

                        <div className="filter-group">
                            <label htmlFor="countySelect"><i className="fa-solid fa-map-marker-alt"></i>County</label>
                            <select
                                id="countySelect"
                                value={selectedCounty}
                                onChange={(e) => setSelectedCounty(e.target.value)}
                                disabled={filtersLoading}
                            >
                                <option value="all">All Counties</option>
                                {(filterOptions?.counties || []).map((county) => (
                                    <option key={county} value={county}>{county}</option>
                                ))}
                            </select>
                        </div>

                        <div className="filter-group">
                            <label htmlFor="statusSelect"><i className="fa-solid fa-clipboard-check"></i>Status</label>
                            <select
                                id="statusSelect"
                                value={selectedStatus}
                                onChange={(e) => setSelectedStatus(e.target.value)}
                                disabled={filtersLoading}
                            >
                                <option value="all">All Statuses</option>
                                {(filterOptions?.statuses || []).map((statusValue) => (
                                    <option key={statusValue} value={statusValue}>{statusValue}</option>
                                ))}
                            </select>
                        </div>

                        <div className="filter-group">
                            <label htmlFor="prioritySelect"><i className="fa-solid fa-flag"></i>Priority</label>
                            <select
                                id="prioritySelect"
                                value={selectedPriorityLevel}
                                onChange={(e) => setSelectedPriorityLevel(e.target.value)}
                                disabled={filtersLoading}
                            >
                                <option value="all">All Priorities</option>
                                {(filterOptions?.priorityLevels || []).map((priority) => (
                                    <option key={priority} value={priority}>{priority}</option>
                                ))}
                            </select>
                        </div>

                        <div className="filter-group">
                            <label htmlFor="startYearSelect"><i className="fa-solid fa-calendar-alt"></i>Start Year</label>
                            <select
                                id="startYearSelect"
                                value={selectedStartYear || ''}
                                onChange={handleStartYearChange}
                                disabled={!yearOptions.length}
                            >
                                <option value="">All Years</option>
                                {yearOptions.map((year) => (
                                    <option key={`start-${year}`} value={year}>{year}</option>
                                ))}
                            </select>
                        </div>

                        <div className="filter-group">
                            <label htmlFor="endYearSelect"><i className="fa-solid fa-calendar-check"></i>End Year</label>
                            <select
                                id="endYearSelect"
                                value={selectedEndYear || ''}
                                onChange={handleEndYearChange}
                                disabled={!yearOptions.length}
                            >
                                <option value="">All Years</option>
                                {yearOptions.map((year) => (
                                    <option key={`end-${year}`} value={year}>{year}</option>
                                ))}
                            </select>
                        </div>

                        <div className="filter-inline">
                            <button className="filter-reset" onClick={resetFilters}>
                                <i className="fa-solid fa-rotate-left"></i>
                                Reset Filters
                            </button>
                        </div>
                    </div>
                    
                    {filtersError && (
                        <div className="error">Unable to load filter options: {filtersError}</div>
                    )}

                    {activeFilterChips.length > 0 && (
                        <div className="active-filters">
                            {activeFilterChips.map((chip, idx) => (
                                <span key={`${chip.label}-${chip.value}-${idx}`} className="filter-chip">
                                    <i className={`fa-solid ${chip.icon}`}></i>
                                    <strong>{chip.label}:</strong> {chip.value}
                                </span>
                            ))}
                        </div>
                    )}

                    {/* Tabs for different analytics sections */}
                    <div className="tabs">
                        <button 
                            className={`tab ${activeTab === 'overview' ? 'active' : ''}`}
                            onClick={() => setActiveTab('overview')}
                        >
                            Overview
                        </button>
                        <button 
                            className={`tab ${activeTab === 'demographics' ? 'active' : ''}`}
                            onClick={() => setActiveTab('demographics')}
                        >
                            Demographics
                        </button>
                        <button 
                            className={`tab ${activeTab === 'trends' ? 'active' : ''}`}
                            onClick={() => setActiveTab('trends')}
                        >
                            Trends
                        </button>
                    </div>

                    {/* Overview Tab */}
                    {activeTab === 'overview' && (
                        <div className="analytics-section">
                            <div className="section-header">ðŸ“ˆ Overview Analytics</div>
                            <div className="charts-grid">
                                <div className="chart-container">
                                    <div className="chart-title"><i className="fa-solid fa-chart-column"></i>Timesheet Counts by Year</div>
                                    {yearData ? (
                                        <canvas ref={yearChartRef} style={{ width: '100%', height: '350px' }}></canvas>
                                    ) : (
                                        <div className="loading">Loading year data...</div>
                                    )}
                                </div>
                                <div className="chart-container">
                                    <div className="chart-title"><i className="fa-solid fa-venus-mars"></i>Gender Distribution</div>
                                    {genderData ? (
                                        <canvas ref={genderChartRef} style={{ width: '100%', height: '350px' }}></canvas>
                                    ) : (
                                        <div className="loading">Loading gender data...</div>
                                    )}
                                </div>
                                <div className="chart-container">
                                    <div className="chart-title"><i className="fa-solid fa-map-location-dot"></i>Members by County</div>
                                    {countyMemberData && countyMemberData.length ? (
                                        <>
                                            <canvas ref={countyChartRef} style={{ width: '100%', height: '350px' }}></canvas>
                                            <div style={{ marginTop: '12px', fontSize: '0.95rem', color: '#555', display: 'flex', gap: '20px', justifyContent: 'center', flexWrap: 'wrap' }}>
                                                <div>
                                                    <span style={{ color: '#667eea', fontWeight: 'bold' }}>Total Providers: </span>
                                                    <strong>{countyProviderTotal.toLocaleString()}</strong>
                                                </div>
                                                <div>
                                                    <span style={{ color: '#764ba2', fontWeight: 'bold' }}>Total Recipients: </span>
                                                    <strong>{countyRecipientTotal.toLocaleString()}</strong>
                                                </div>
                                                <div>
                                                    <span style={{ fontWeight: 'bold' }}>Total Members: </span>
                                                    <strong>{countyMemberTotal.toLocaleString()}</strong>
                                                </div>
                                            </div>
                                        </>
                                    ) : (
                                        <div className="loading">No county member data for the selected filters.</div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Demographics Tab */}
                    {activeTab === 'demographics' && (
                        <div className="analytics-section">
                            <div className="section-header">ðŸ‘¥ Demographic Analytics</div>
                            <div className="charts-grid">
                                <div className="chart-container">
                                    <div className="chart-title"><i className="fa-solid fa-venus-mars"></i>Gender Distribution (Providers vs Recipients)</div>
                                    {genderData ? (
                                        <canvas ref={genderChartRef} style={{ width: '100%', height: '350px' }}></canvas>
                                    ) : (
                                        <div className="loading">Loading gender data...</div>
                                    )}
                                </div>
                                <div className="chart-container">
                                    <div className="chart-title"><i className="fa-solid fa-users"></i>Provider Ethnicity Distribution</div>
                                    {ethnicityData ? (
                                        <canvas ref={ethnicityChartRef} style={{ width: '100%', height: '350px' }}></canvas>
                                    ) : (
                                        <div className="loading">Loading ethnicity data...</div>
                                    )}
                                </div>
                                <div className="chart-container">
                                    <div className="chart-title"><i className="fa-solid fa-user-clock"></i>Age Group Distribution</div>
                                    {ageData ? (
                                        <canvas ref={ageChartRef} style={{ width: '100%', height: '350px' }}></canvas>
                                    ) : (
                                        <div className="loading">Loading age data...</div>
                                    )}
                                </div>
                            </div>

                            {/* Demographic Statistics Table */}
                            {genderData && (
                                <div style={{ marginTop: '30px' }}>
                                    <h3 style={{ marginBottom: '15px' }}>Demographic Statistics</h3>
                                    <table className="stats-table">
                                        <thead>
                                            <tr>
                                                <th>Category</th>
                                                <th>Type</th>
                                                <th>Count</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {Object.entries(genderData.provider || {}).map(([gender, count]) => (
                                                <tr key={`provider-${gender}`}>
                                                    <td>Provider</td>
                                                    <td>{gender}</td>
                                                    <td>{count}</td>
                                                </tr>
                                            ))}
                                            {Object.entries(genderData.recipient || {}).map(([gender, count]) => (
                                                <tr key={`recipient-${gender}`}>
                                                    <td>Recipient</td>
                                                    <td>{gender}</td>
                                                    <td>{count}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Trends Tab */}
                    {activeTab === 'trends' && (
                        <div className="analytics-section">
                            <div className="section-header">ðŸ“Š Trend Analysis</div>
                            <div className="charts-grid">
                                <div className="chart-container">
                                    <div className="chart-title"><i className="fa-solid fa-chart-line"></i>Timesheet Trends by Year</div>
                                    {yearData ? (
                                        <canvas ref={yearChartRef} style={{ width: '100%', height: '350px' }}></canvas>
                                    ) : (
                                        <div className="loading">Loading year data...</div>
                                    )}
                                </div>
                                <div className="chart-container">
                                    <div className="chart-title"><i className="fa-solid fa-chart-area"></i>Age Group Trends</div>
                                    {ageData ? (
                                        <canvas ref={ageChartRef} style={{ width: '100%', height: '350px' }}></canvas>
                                    ) : (
                                        <div className="loading">Loading age data...</div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(<TableauAnalyticsDashboard />, document.getElementById('root'));
    </script>
</body>
</html>

