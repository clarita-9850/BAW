<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ad-hoc Analytics Workbench</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #1f2937;
            min-height: 100vh;
        }

        .layout {
            display: grid;
            grid-template-columns: 320px 1fr;
            min-height: 100vh;
        }

        .sidebar {
            background: #111827;
            color: #f9fafb;
            padding: 28px 24px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .sidebar h1 {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar p.description {
            font-size: 0.95rem;
            line-height: 1.4;
            color: #d1d5db;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .filter-group h2 {
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            color: #9ca3af;
        }

        .column-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .column-option label {
            flex: 1;
            cursor: pointer;
            font-size: 0.95rem;
        }

        .column-option label span {
            display: block;
            font-size: 0.8rem;
            color: #9ca3af;
        }

        .column-option input[type="checkbox"] {
            accent-color: #60a5fa;
            width: 18px;
            height: 18px;
        }

        .sidebar-actions {
            display: flex;
            gap: 10px;
        }

        .sidebar-actions button {
            flex: 1;
            padding: 10px 12px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }

        .sidebar-actions .primary {
            background: #2563eb;
            color: white;
        }

        .sidebar-actions .primary:hover {
            background: #1d4ed8;
        }

        .sidebar-actions .ghost {
            background: rgba(255, 255, 255, 0.1);
            color: #f9fafb;
        }

        .sidebar-actions .ghost:hover {
            background: rgba(255, 255, 255, 0.18);
        }

        .content {
            padding: 28px 32px;
            display: flex;
            flex-direction: column;
            gap: 22px;
            background: #f5f7fa;
        }

        .header {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            justify-content: space-between;
        }

        .header .title-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .header h2 {
            font-size: 1.4rem;
            font-weight: 700;
            color: #111827;
        }

        .header span.meta {
            font-size: 0.9rem;
            color: #4b5563;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }

        .controls input[type="text"] {
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            min-width: 240px;
            font-size: 0.95rem;
            background: white;
        }

        .controls select {
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.95rem;
            background: white;
        }

        .controls button {
            padding: 10px 14px;
            border: none;
            border-radius: 6px;
            background: #2563eb;
            color: white;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease-in-out;
        }

        .controls button:hover {
            background: #1d4ed8;
        }

        .table-wrapper {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(15, 23, 42, 0.08);
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }

        .table-container {
            overflow: auto;
            max-height: calc(100vh - 220px);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px;
        }

        thead {
            background: #1f2937;
            color: #f9fafb;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        th {
            padding: 12px 16px;
            text-align: left;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            position: relative;
            cursor: pointer;
        }

        th .sort-icon {
            margin-left: 8px;
            font-size: 0.85rem;
            opacity: 0.7;
        }

        tbody tr:nth-child(even) {
            background: #f9fafb;
        }

        td {
            padding: 12px 16px;
            font-size: 0.93rem;
            border-bottom: 1px solid #e5e7eb;
            color: #1f2937;
        }

        td.numeric {
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        .empty-state {
            padding: 40px;
            text-align: center;
            color: #6b7280;
        }

        .demographic-filters {
            margin-top: 8px;
        }

        .demographic-filters h3 {
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            color: #9ca3af;
            margin-bottom: 12px;
            margin-top: 16px;
        }

        .demographic-filters h3:first-child {
            margin-top: 0;
        }

        .demographic-filters select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.08);
            color: #f9fafb;
            font-size: 0.9rem;
            margin-bottom: 12px;
            cursor: pointer;
        }

        .demographic-filters select:hover {
            background: rgba(255, 255, 255, 0.12);
        }

        .demographic-filters select option {
            background: #111827;
            color: #f9fafb;
        }


        .active-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .filter-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: rgba(37, 99, 235, 0.2);
            border: 1px solid rgba(37, 99, 235, 0.3);
            border-radius: 12px;
            font-size: 0.8rem;
            color: #93c5fd;
        }

        .filter-chip button {
            background: none;
            border: none;
            color: #93c5fd;
            cursor: pointer;
            padding: 0;
            margin-left: 4px;
            font-size: 0.9rem;
        }

        .filter-chip button:hover {
            color: #f9fafb;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .breakdowns-section, .crosstab-section {
            margin-bottom: 32px;
        }

        .breakdown-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .breakdown-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(15, 23, 42, 0.08);
            border: 1px solid #e5e7eb;
        }

        .breakdown-header {
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
        }

        .breakdown-header h4 {
            font-size: 1rem;
            font-weight: 600;
            color: #111827;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .breakdown-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: #f9fafb;
            border-radius: 6px;
            border-left: 3px solid #2563eb;
        }

        .breakdown-label {
            font-size: 0.95rem;
            color: #4b5563;
            font-weight: 500;
        }

        .breakdown-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #111827;
        }

        .crosstab-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .crosstab-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(15, 23, 42, 0.08);
            border: 1px solid #e5e7eb;
        }

        .crosstab-header {
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
        }

        .crosstab-header h4 {
            font-size: 1rem;
            font-weight: 600;
            color: #111827;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .crosstab-content {
            overflow-x: auto;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
            margin-top: 16px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            overflow: hidden;
        }

        .report-table thead {
            background: #1f2937;
            color: #f9fafb;
        }

        .report-table th {
            padding: 14px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #111827;
        }

        .report-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #e5e7eb;
            color: #1f2937;
        }

        .report-table tbody tr:last-child td {
            border-bottom: none;
        }

        .report-table tbody tr:hover {
            background: #f9fafb;
        }

        .report-table tbody tr:nth-child(even) {
            background: #fafbfc;
        }

        .report-table tbody tr:nth-child(even):hover {
            background: #f3f4f6;
        }

        .crosstab-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .crosstab-table thead {
            background: #f9fafb;
        }

        .crosstab-table th {
            padding: 10px 12px;
            text-align: left;
            font-weight: 600;
            color: #4b5563;
            border-bottom: 2px solid #e5e7eb;
        }

        .crosstab-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e5e7eb;
            color: #1f2937;
        }

        .crosstab-table tbody tr:hover {
            background: #f9fafb;
        }

        .loading-text, .empty-text {
            text-align: center;
            padding: 20px;
            color: #6b7280;
            font-size: 0.9rem;
        }

        .report-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .report-options h3 {
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            color: #9ca3af;
            margin-bottom: 8px;
        }

        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
        }

        .checkbox-option input[type="checkbox"] {
            accent-color: #60a5fa;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-option label {
            cursor: pointer;
            font-size: 0.95rem;
            color: #f9fafb;
            flex: 1;
        }

        .report-page {
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(15, 23, 42, 0.08);
            max-width: 1200px;
            margin: 0 auto;
        }

        .report-header {
            border-bottom: 3px solid #2563eb;
            padding-bottom: 24px;
            margin-bottom: 32px;
        }

        .report-title-section {
            margin-bottom: 16px;
        }

        .report-title {
            font-size: 2rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 8px;
        }

        .report-meta {
            font-size: 0.9rem;
            color: #6b7280;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .report-filters-applied {
            margin-top: 16px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 6px;
            border-left: 4px solid #2563eb;
        }

        .report-filters-applied strong {
            display: block;
            margin-bottom: 8px;
            color: #4b5563;
            font-size: 0.9rem;
        }

        .filter-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .filter-tag {
            display: inline-block;
            padding: 4px 12px;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 12px;
            font-size: 0.85rem;
            color: #4b5563;
        }

        .report-section {
            margin-bottom: 40px;
            page-break-inside: avoid;
        }

        .report-section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
        }

        .report-footer {
            margin-top: 48px;
            padding-top: 24px;
            border-top: 2px solid #e5e7eb;
        }

        .report-footer-line {
            height: 1px;
            background: #e5e7eb;
            margin-bottom: 16px;
        }

        .report-footer-text {
            text-align: center;
            font-size: 0.85rem;
            color: #6b7280;
            font-style: italic;
        }

        .breakdowns-section, .crosstab-section {
            margin-bottom: 0;
        }

        .section-title {
            display: none;
        }

        @media (max-width: 1024px) {
            .layout {
                grid-template-columns: 1fr;
            }

            .sidebar {
                border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            }

            .content {
                padding: 20px 18px 40px;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;


        const AdhocAnalyticsDashboard = () => {
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            
            // Demographic filter states
            const [providerGender, setProviderGender] = useState('');
            const [providerAgeGroup, setProviderAgeGroup] = useState('');
            const [providerEthnicity, setProviderEthnicity] = useState('');
            const [recipientGender, setRecipientGender] = useState('');
            const [recipientAgeGroup, setRecipientAgeGroup] = useState('');
            const [recipientEthnicity, setRecipientEthnicity] = useState('');
            
            // Filter options
            const [genders, setGenders] = useState([]);
            const [ethnicities, setEthnicities] = useState([]);
            const [ageGroups, setAgeGroups] = useState([]);
            
            // Stats state
            const [stats, setStats] = useState({
                totalRecords: 0,
                totalHours: 0,
                totalAmount: 0,
                avgHours: 0,
                avgAmount: 0
            });
            const [statsLoading, setStatsLoading] = useState(false);
            
            // Selected breakdowns to show
            const [selectedBreakdowns, setSelectedBreakdowns] = useState({
                gender: false,
                ethnicity: false,
                ageGroup: false
            });
            
            // Selected cross-tabulations to show
            const [selectedCrosstabs, setSelectedCrosstabs] = useState({
                genderEthnicity: false,
                genderAge: false,
                ethnicityAge: false
            });
            
            // Breakdowns state
            const [breakdowns, setBreakdowns] = useState({
                gender: {},
                ethnicity: {},
                ageGroup: {}
            });
            const [breakdownsLoading, setBreakdownsLoading] = useState(false);
            
            // Cross-tabulations state
            const [crosstabs, setCrosstabs] = useState({
                genderEthnicity: [],
                genderAge: [],
                ethnicityAge: []
            });
            const [crosstabsLoading, setCrosstabsLoading] = useState(false);
            
            const [reportGenerated, setReportGenerated] = useState(false);

            const fetchFilterOptions = useCallback(async () => {
                try {
                    const response = await fetch('/api/analytics/adhoc-filters');
                    if (!response.ok) {
                        throw new Error('Failed to fetch filter options');
                    }
                    const payload = await response.json();
                    if (payload.status === 'SUCCESS') {
                        setGenders(payload.genders || []);
                        setEthnicities(payload.ethnicities || []);
                        setAgeGroups(payload.ageGroups || []);
                    }
                } catch (err) {
                    console.error('Failed to fetch filter options:', err);
                }
            }, []);

            const fetchStats = useCallback(async () => {
                setStatsLoading(true);
                try {
                    const params = new URLSearchParams();
                    if (providerGender) params.append('providerGender', providerGender);
                    if (providerAgeGroup) params.append('providerAgeGroup', providerAgeGroup);
                    if (providerEthnicity) params.append('providerEthnicity', providerEthnicity);
                    if (recipientGender) params.append('recipientGender', recipientGender);
                    if (recipientAgeGroup) params.append('recipientAgeGroup', recipientAgeGroup);
                    if (recipientEthnicity) params.append('recipientEthnicity', recipientEthnicity);
                    
                    const response = await fetch(`/api/analytics/adhoc-stats?${params.toString()}`);
                    if (!response.ok) {
                        throw new Error('Failed to fetch stats');
                    }
                    const payload = await response.json();
                    if (payload.status === 'SUCCESS' && payload.stats) {
                        setStats(payload.stats);
                    }
                } catch (err) {
                    console.error('Failed to fetch stats:', err);
                } finally {
                    setStatsLoading(false);
                }
            }, [providerGender, providerAgeGroup, providerEthnicity, recipientGender, recipientAgeGroup, recipientEthnicity]);

            const fetchBreakdowns = useCallback(async () => {
                if (!selectedBreakdowns.gender && !selectedBreakdowns.ethnicity && !selectedBreakdowns.ageGroup) {
                    return;
                }
                
                setBreakdownsLoading(true);
                try {
                    const params = new URLSearchParams();
                    if (providerGender) params.append('providerGender', providerGender);
                    if (providerAgeGroup) params.append('providerAgeGroup', providerAgeGroup);
                    if (providerEthnicity) params.append('providerEthnicity', providerEthnicity);
                    if (recipientGender) params.append('recipientGender', recipientGender);
                    if (recipientAgeGroup) params.append('recipientAgeGroup', recipientAgeGroup);
                    if (recipientEthnicity) params.append('recipientEthnicity', recipientEthnicity);
                    
                    const response = await fetch(`/api/analytics/adhoc-breakdowns?${params.toString()}`);
                    if (!response.ok) {
                        throw new Error('Failed to fetch breakdowns');
                    }
                    const payload = await response.json();
                    if (payload.status === 'SUCCESS') {
                        setBreakdowns({
                            gender: payload.gender || {},
                            ethnicity: payload.ethnicity || {},
                            ageGroup: payload.ageGroup || {}
                        });
                    }
                } catch (err) {
                    console.error('Failed to fetch breakdowns:', err);
                } finally {
                    setBreakdownsLoading(false);
                }
            }, [providerGender, providerAgeGroup, providerEthnicity, recipientGender, recipientAgeGroup, recipientEthnicity, selectedBreakdowns]);

            const fetchCrosstabs = useCallback(async () => {
                if (!selectedCrosstabs.genderEthnicity && !selectedCrosstabs.genderAge && !selectedCrosstabs.ethnicityAge) {
                    return;
                }
                
                setCrosstabsLoading(true);
                try {
                    const params = new URLSearchParams();
                    if (providerGender) params.append('providerGender', providerGender);
                    if (providerAgeGroup) params.append('providerAgeGroup', providerAgeGroup);
                    if (providerEthnicity) params.append('providerEthnicity', providerEthnicity);
                    if (recipientGender) params.append('recipientGender', recipientGender);
                    if (recipientAgeGroup) params.append('recipientAgeGroup', recipientAgeGroup);
                    if (recipientEthnicity) params.append('recipientEthnicity', recipientEthnicity);
                    
                    const response = await fetch(`/api/analytics/adhoc-crosstab?${params.toString()}`);
                    if (!response.ok) {
                        throw new Error('Failed to fetch cross-tabulations');
                    }
                    const payload = await response.json();
                    if (payload.status === 'SUCCESS') {
                        setCrosstabs({
                            genderEthnicity: payload.genderEthnicity || [],
                            genderAge: payload.genderAge || [],
                            ethnicityAge: payload.ethnicityAge || []
                        });
                    }
                } catch (err) {
                    console.error('Failed to fetch cross-tabulations:', err);
                } finally {
                    setCrosstabsLoading(false);
                }
            }, [providerGender, providerAgeGroup, providerEthnicity, recipientGender, recipientAgeGroup, recipientEthnicity, selectedCrosstabs]);
            
            const generateReport = () => {
                setReportGenerated(true);
                fetchStats();
                fetchBreakdowns();
                fetchCrosstabs();
            };
            
            const hasActiveFilters = useMemo(() => {
                return providerGender || providerAgeGroup || providerEthnicity || 
                       recipientGender || recipientAgeGroup || recipientEthnicity;
            }, [providerGender, providerAgeGroup, providerEthnicity, recipientGender, recipientAgeGroup, recipientEthnicity]);

            useEffect(() => {
                fetchFilterOptions();
                setLoading(false);
            }, [fetchFilterOptions]);
            
            const clearFilters = () => {
                setProviderGender('');
                setProviderAgeGroup('');
                setProviderEthnicity('');
                setRecipientGender('');
                setRecipientAgeGroup('');
                setRecipientEthnicity('');
            };

            return (
                <div className="layout">
                    <aside className="sidebar">
                        <div>
                            <h1><i className="fa-solid fa-chart-bar"></i> Ad-hoc Analytics</h1>
                            <p className="description">
                                View demographic breakdowns and cross-tabulations. Filter by gender, ethnicity, and age groups
                                to analyze participant statistics.
                            </p>
                        </div>

                        <div className="filter-group">
                            <h2>Demographic Filters</h2>
                            <div className="demographic-filters">
                                <h3>Provider</h3>
                                <select value={providerGender} onChange={(e) => setProviderGender(e.target.value)}>
                                    <option value="">All Genders</option>
                                    {genders.map(g => <option key={g} value={g}>{g}</option>)}
                                </select>
                                <select value={providerAgeGroup} onChange={(e) => setProviderAgeGroup(e.target.value)}>
                                    <option value="">All Age Groups</option>
                                    {ageGroups.filter(ag => ['25-34', '35-44', '45-54', '55-64', '65+'].includes(ag)).map(ag => 
                                        <option key={ag} value={ag}>{ag}</option>
                                    )}
                                </select>
                                <select value={providerEthnicity} onChange={(e) => setProviderEthnicity(e.target.value)}>
                                    <option value="">All Ethnicities</option>
                                    {ethnicities.map(e => <option key={e} value={e}>{e}</option>)}
                                </select>
                                
                                <h3>Recipient</h3>
                                <select value={recipientGender} onChange={(e) => setRecipientGender(e.target.value)}>
                                    <option value="">All Genders</option>
                                    {genders.map(g => <option key={g} value={g}>{g}</option>)}
                                </select>
                                <select value={recipientAgeGroup} onChange={(e) => setRecipientAgeGroup(e.target.value)}>
                                    <option value="">All Age Groups</option>
                                    {ageGroups.filter(ag => ['30-39', '40-49', '50-59', '60-69', '70-79', '80+'].includes(ag)).map(ag => 
                                        <option key={ag} value={ag}>{ag}</option>
                                    )}
                                </select>
                                <select value={recipientEthnicity} onChange={(e) => setRecipientEthnicity(e.target.value)}>
                                    <option value="">All Ethnicities</option>
                                    {ethnicities.map(e => <option key={e} value={e}>{e}</option>)}
                                </select>
                            </div>
                            
                            {hasActiveFilters && (
                                <div className="active-filters">
                                    {providerGender && (
                                        <span className="filter-chip">
                                            Provider: {providerGender}
                                            <button onClick={() => setProviderGender('')}>×</button>
                                        </span>
                                    )}
                                    {providerAgeGroup && (
                                        <span className="filter-chip">
                                            Provider Age: {providerAgeGroup}
                                            <button onClick={() => setProviderAgeGroup('')}>×</button>
                                        </span>
                                    )}
                                    {providerEthnicity && (
                                        <span className="filter-chip">
                                            Provider: {providerEthnicity}
                                            <button onClick={() => setProviderEthnicity('')}>×</button>
                                        </span>
                                    )}
                                    {recipientGender && (
                                        <span className="filter-chip">
                                            Recipient: {recipientGender}
                                            <button onClick={() => setRecipientGender('')}>×</button>
                                        </span>
                                    )}
                                    {recipientAgeGroup && (
                                        <span className="filter-chip">
                                            Recipient Age: {recipientAgeGroup}
                                            <button onClick={() => setRecipientAgeGroup('')}>×</button>
                                        </span>
                                    )}
                                    {recipientEthnicity && (
                                        <span className="filter-chip">
                                            Recipient: {recipientEthnicity}
                                            <button onClick={() => setRecipientEthnicity('')}>×</button>
                                        </span>
                                    )}
                                    <button className="ghost" onClick={clearFilters} style={{ marginTop: '8px', width: '100%' }}>
                                        Clear All Filters
                                    </button>
                                </div>
                            )}
                        </div>

                        <div className="filter-group">
                            <h2>Report Options</h2>
                            <div className="report-options">
                                <h3>Demographic Breakdowns</h3>
                                <div className="checkbox-option">
                                    <input
                                        type="checkbox"
                                        id="breakdown-gender"
                                        checked={selectedBreakdowns.gender}
                                        onChange={(e) => setSelectedBreakdowns(prev => ({ ...prev, gender: e.target.checked }))}
                                    />
                                    <label htmlFor="breakdown-gender">Gender Distribution</label>
                                </div>
                                <div className="checkbox-option">
                                    <input
                                        type="checkbox"
                                        id="breakdown-ethnicity"
                                        checked={selectedBreakdowns.ethnicity}
                                        onChange={(e) => setSelectedBreakdowns(prev => ({ ...prev, ethnicity: e.target.checked }))}
                                    />
                                    <label htmlFor="breakdown-ethnicity">Ethnicity Distribution</label>
                                </div>
                                <div className="checkbox-option">
                                    <input
                                        type="checkbox"
                                        id="breakdown-age"
                                        checked={selectedBreakdowns.ageGroup}
                                        onChange={(e) => setSelectedBreakdowns(prev => ({ ...prev, ageGroup: e.target.checked }))}
                                    />
                                    <label htmlFor="breakdown-age">Age Group Distribution</label>
                                </div>
                                
                                <h3 style={{ marginTop: '20px' }}>Cross-Tabulations</h3>
                                <div className="checkbox-option">
                                    <input
                                        type="checkbox"
                                        id="crosstab-gender-ethnicity"
                                        checked={selectedCrosstabs.genderEthnicity}
                                        onChange={(e) => setSelectedCrosstabs(prev => ({ ...prev, genderEthnicity: e.target.checked }))}
                                    />
                                    <label htmlFor="crosstab-gender-ethnicity">Gender × Ethnicity</label>
                                </div>
                                <div className="checkbox-option">
                                    <input
                                        type="checkbox"
                                        id="crosstab-gender-age"
                                        checked={selectedCrosstabs.genderAge}
                                        onChange={(e) => setSelectedCrosstabs(prev => ({ ...prev, genderAge: e.target.checked }))}
                                    />
                                    <label htmlFor="crosstab-gender-age">Gender × Age Group</label>
                                </div>
                                <div className="checkbox-option">
                                    <input
                                        type="checkbox"
                                        id="crosstab-ethnicity-age"
                                        checked={selectedCrosstabs.ethnicityAge}
                                        onChange={(e) => setSelectedCrosstabs(prev => ({ ...prev, ethnicityAge: e.target.checked }))}
                                    />
                                    <label htmlFor="crosstab-ethnicity-age">Ethnicity × Age Group</label>
                                </div>
                            </div>
                            
                            <div className="sidebar-actions" style={{ marginTop: '20px' }}>
                                <button className="primary" onClick={generateReport} style={{ width: '100%' }}>
                                    <i className="fa-solid fa-chart-line" style={{ marginRight: 8 }}></i>
                                    Generate Report
                                </button>
                            </div>
                        </div>

                    </aside>

                    <main className="content">
                        {!reportGenerated && (
                            <div className="header">
                                <div className="title-group">
                                    <h2>Ad-hoc Analytics Dashboard</h2>
                                    <span className="meta">
                                        Generate custom demographic reports with breakdowns and cross-tabulations
                                    </span>
                                </div>
                            </div>
                        )}

                        {!reportGenerated ? (
                            <div className="empty-state" style={{ padding: '60px 20px', textAlign: 'center' }}>
                                <i className="fa-solid fa-chart-bar" style={{ fontSize: '3rem', color: '#9ca3af', marginBottom: '20px' }}></i>
                                <h3 style={{ color: '#4b5563', marginBottom: '10px' }}>No Report Generated</h3>
                                <p style={{ color: '#6b7280' }}>Select demographic breakdowns and/or cross-tabulations in the sidebar, then click "Generate Report" to view statistics.</p>
                            </div>
                        ) : (
                            <div className="report-page">
                                {/* Report Header */}
                                <div className="report-header">
                                    <div className="report-title-section">
                                        <h1 className="report-title">Demographic Analytics Report</h1>
                                        <div className="report-meta">
                                            <span><i className="fa-solid fa-calendar"></i> Generated: {new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</span>
                                        </div>
                                    </div>
                                    {hasActiveFilters && (
                                        <div className="report-filters-applied">
                                            <strong>Filters Applied:</strong>
                                            <div className="filter-tags">
                                                {providerGender && <span className="filter-tag">Provider Gender: {providerGender}</span>}
                                                {providerAgeGroup && <span className="filter-tag">Provider Age: {providerAgeGroup}</span>}
                                                {providerEthnicity && <span className="filter-tag">Provider: {providerEthnicity}</span>}
                                                {recipientGender && <span className="filter-tag">Recipient Gender: {recipientGender}</span>}
                                                {recipientAgeGroup && <span className="filter-tag">Recipient Age: {recipientAgeGroup}</span>}
                                                {recipientEthnicity && <span className="filter-tag">Recipient: {recipientEthnicity}</span>}
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Executive Summary */}
                                <div className="report-section">
                                    <h2 className="report-section-title">Executive Summary</h2>
                                    <table className="report-table">
                                        <thead>
                                            <tr>
                                                <th>Metric</th>
                                                <th>Value</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>Total Records</td>
                                                <td className="numeric">{statsLoading ? '...' : new Intl.NumberFormat().format(stats.totalRecords)}</td>
                                            </tr>
                                            <tr>
                                                <td>Total Hours</td>
                                                <td className="numeric">{statsLoading ? '...' : new Intl.NumberFormat(undefined, {
                                                    minimumFractionDigits: 1,
                                                    maximumFractionDigits: 1
                                                }).format(stats.totalHours)}</td>
                                            </tr>
                                            <tr>
                                                <td>Total Amount</td>
                                                <td className="numeric">{statsLoading ? '...' : new Intl.NumberFormat('en-US', {
                                                    style: 'currency',
                                                    currency: 'USD',
                                                    minimumFractionDigits: 2,
                                                    maximumFractionDigits: 2
                                                }).format(stats.totalAmount)}</td>
                                            </tr>
                                            <tr>
                                                <td>Average Hours</td>
                                                <td className="numeric">{statsLoading ? '...' : new Intl.NumberFormat(undefined, {
                                                    minimumFractionDigits: 1,
                                                    maximumFractionDigits: 1
                                                }).format(stats.avgHours)}</td>
                                            </tr>
                                            <tr>
                                                <td>Average Amount</td>
                                                <td className="numeric">{statsLoading ? '...' : new Intl.NumberFormat('en-US', {
                                                    style: 'currency',
                                                    currency: 'USD',
                                                    minimumFractionDigits: 2,
                                                    maximumFractionDigits: 2
                                                }).format(stats.avgAmount)}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                {/* Unified Demographic Report Table */}
                                {(selectedBreakdowns.gender || selectedBreakdowns.ethnicity || selectedBreakdowns.ageGroup || 
                                  selectedCrosstabs.genderEthnicity || selectedCrosstabs.genderAge || selectedCrosstabs.ethnicityAge) && (
                                    <div className="report-section">
                                        <h2 className="report-section-title">Demographic Analysis</h2>
                                        
                                        {(() => {
                                            // Build unified report data
                                            const reportRows = [];
                                            
                                            // Add breakdown rows
                                            if (selectedBreakdowns.gender && breakdowns.gender) {
                                                Object.entries(breakdowns.gender).forEach(([key, value]) => {
                                                    reportRows.push({
                                                        category: 'Gender',
                                                        value: key,
                                                        count: value
                                                    });
                                                });
                                            }
                                            
                                            if (selectedBreakdowns.ethnicity && breakdowns.ethnicity) {
                                                Object.entries(breakdowns.ethnicity).forEach(([key, value]) => {
                                                    reportRows.push({
                                                        category: 'Ethnicity',
                                                        value: key,
                                                        count: value
                                                    });
                                                });
                                            }
                                            
                                            if (selectedBreakdowns.ageGroup && breakdowns.ageGroup) {
                                                Object.entries(breakdowns.ageGroup).forEach(([key, value]) => {
                                                    reportRows.push({
                                                        category: 'Age Group',
                                                        value: key,
                                                        count: value
                                                    });
                                                });
                                            }
                                            
                                            // Add cross-tabulation rows
                                            if (selectedCrosstabs.genderEthnicity && crosstabs.genderEthnicity.length > 0) {
                                                crosstabs.genderEthnicity.forEach(item => {
                                                    reportRows.push({
                                                        category: 'Gender × Ethnicity',
                                                        value: `${item.gender} × ${item.ethnicity}`,
                                                        count: item.count
                                                    });
                                                });
                                            }
                                            
                                            if (selectedCrosstabs.genderAge && crosstabs.genderAge.length > 0) {
                                                crosstabs.genderAge.forEach(item => {
                                                    reportRows.push({
                                                        category: 'Gender × Age Group',
                                                        value: `${item.gender} × ${item.ageGroup}`,
                                                        count: item.count
                                                    });
                                                });
                                            }
                                            
                                            if (selectedCrosstabs.ethnicityAge && crosstabs.ethnicityAge.length > 0) {
                                                crosstabs.ethnicityAge.forEach(item => {
                                                    reportRows.push({
                                                        category: 'Ethnicity × Age Group',
                                                        value: `${item.ethnicity} × ${item.ageGroup}`,
                                                        count: item.count
                                                    });
                                                });
                                            }
                                            
                                            // Merge rows with same category and value
                                            const mergedRows = {};
                                            reportRows.forEach(row => {
                                                const key = `${row.category}|${row.value}`;
                                                if (mergedRows[key]) {
                                                    mergedRows[key].count += row.count;
                                                } else {
                                                    mergedRows[key] = { ...row };
                                                }
                                            });
                                            
                                            const finalRows = Object.values(mergedRows).sort((a, b) => {
                                                if (a.category !== b.category) {
                                                    return a.category.localeCompare(b.category);
                                                }
                                                return b.count - a.count;
                                            });
                                            
                                            return (
                                                breakdownsLoading || crosstabsLoading ? (
                                                    <div className="loading-text">Loading report data...</div>
                                                ) : finalRows.length === 0 ? (
                                                    <div className="empty-text">No data available</div>
                                                ) : (
                                                    <table className="report-table">
                                                        <thead>
                                                            <tr>
                                                                <th>Category</th>
                                                                <th>Value</th>
                                                                <th>Count</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {finalRows.map((row, idx) => (
                                                                <tr key={idx}>
                                                                    <td>{row.category}</td>
                                                                    <td>{row.value}</td>
                                                                    <td className="numeric">{new Intl.NumberFormat().format(row.count)}</td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                )
                                            );
                                        })()}
                                    </div>
                                )}

                                {/* Report Footer */}
                                <div className="report-footer">
                                    <div className="report-footer-line"></div>
                                    <p className="report-footer-text">
                                        This report was generated on {new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })} 
                                        {hasActiveFilters && ' with applied demographic filters.'}
                                    </p>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        ReactDOM.render(<AdhocAnalyticsDashboard />, document.getElementById('root'));
    </script>
</body>
</html>

