<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Field Masking Configuration Interface</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        /* Authentication Section Styles */
        .auth-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .auth-form {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .auth-form input {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
        }

        .auth-form button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background: #4facfe;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .auth-form button:hover {
            background: #00f2fe;
            transform: translateY(-2px);
        }

        .user-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .user-info h3 {
            margin-bottom: 10px;
            color: #fff;
        }

        .user-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .user-detail {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 14px;
        }

        .logout-btn {
            background: #e74c3c !important;
            margin-top: 10px;
        }

        .logout-btn:hover {
            background: #c0392b !important;
        }

        .role-selector {
            margin-bottom: 30px;
        }

        .role-selector label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .role-selector select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            transition: border-color 0.3s;
        }

        .role-selector select:focus {
            outline: none;
            border-color: #4facfe;
        }


        .fields-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 3px solid #4facfe;
            padding-bottom: 10px;
        }

        .field-selection-section {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .field-selection-help {
            background: #e8f4fd;
            border-left: 4px solid #4facfe;
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 0.9rem;
            color: #2c3e50;
        }

        .field-selection-controls {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .field-selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .field-selection-item {
            display: flex;
            align-items: flex-start;
            padding: 12px 15px;
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 8px;
        }

        .field-selection-item:hover {
            background: #f0f8ff;
            border-color: #4facfe;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(79, 172, 254, 0.2);
        }

        .field-selection-item input[type="checkbox"] {
            margin-right: 12px;
            margin-top: 2px;
            transform: scale(1.2);
            cursor: pointer;
        }

        .field-selection-item label {
            cursor: pointer;
            flex: 1;
            line-height: 1.4;
        }

        .field-selection-item label strong {
            display: block;
            color: #2c3e50;
            font-size: 0.95rem;
            margin-bottom: 2px;
        }

        .field-selection-item label small {
            color: #7f8c8d;
            font-size: 0.8rem;
        }

        .field-selection-item .field-type {
            color: #3498db;
            font-size: 0.75rem;
            font-weight: 500;
            background: #ecf0f1;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .fields-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .field-card {
            background: #f8f9fa;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }

        .field-card:hover {
            border-color: #4facfe;
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.1);
        }

        .field-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .field-name {
            font-weight: 600;
            color: #333;
            font-size: 1.1rem;
        }

        .field-type {
            background: #4facfe;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .field-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-group label {
            font-weight: 500;
            color: #555;
            font-size: 0.9rem;
        }

        .control-group select,
        .control-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .control-group select:focus,
        .control-group input:focus {
            outline: none;
            border-color: #4facfe;
        }

        .actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4facfe;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .legend {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .legend h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            margin-right: 10px;
        }

        .legend-text {
            font-size: 14px;
            color: #555;
        }

        /* Action Configuration Styles */
        .action-config-section {
            margin: 30px 0;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 1px solid #e9ecef;
        }

        .action-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .action-category {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .action-category h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.2rem;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }

        .action-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .action-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .action-item:hover {
            border-color: #007bff;
            background: #f0f8ff;
        }

        .action-item label {
            display: flex;
            flex-direction: column;
            cursor: pointer;
            gap: 5px;
        }

        .action-item input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .action-name {
            font-weight: 600;
            color: #495057;
            font-size: 1rem;
        }

        .action-description {
            color: #6c757d;
            font-size: 0.9rem;
            font-style: italic;
        }

        .action-summary {
            margin-top: 25px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }

        .action-summary h3 {
            color: #495057;
            margin-bottom: 15px;
        }

        .summary-stats {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            min-width: 120px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîí Field Masking Configuration</h1>
            <p>Configure field visibility and masking rules for different user roles</p>
        </div>

        <div class="content">
            <div class="status-message" id="statusMessage"></div>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Loading configuration...</p>
            </div>

            <div class="legend">
                <h3>üìã Configuration Guide</h3>
                <div class="legend-item">
                    <div class="legend-color" style="background: #28a745;"></div>
                    <div class="legend-text"><strong>Full Access:</strong> Show complete data without any masking</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ffc107;"></div>
                    <div class="legend-text"><strong>Masked Access:</strong> Show data with applied masking (partial, hash, anonymize)</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #dc3545;"></div>
                    <div class="legend-text"><strong>Hidden Access:</strong> Completely hide the field from view</div>
                </div>
            </div>

            <!-- Authentication Section -->
            <div class="auth-section" id="authSection">
                <div id="loginForm">
                    <h3>üîê Login to Field Masking Interface</h3>
                    <div class="auth-form">
                        <input type="text" id="username" placeholder="Username" required>
                        <input type="password" id="password" placeholder="Password" required>
                        <button onclick="loginUser()">Login</button>
                    </div>
                </div>
                
                <div id="userInfo" style="display: none;">
                    <h3>üë§ Welcome, <span id="userDisplayName"></span></h3>
                    <div class="user-details">
                        <div class="user-detail"><strong>Role:</strong> <span id="userRoleDisplay"></span></div>
                        <div class="user-detail"><strong>Session:</strong> <span id="sessionStatus"></span></div>
                        <div class="user-detail"><strong>Access Level:</strong> <span id="accessLevel"></span></div>
                    </div>
                    <button class="logout-btn" onclick="logoutUser()">Logout</button>
                </div>
            </div>

            <div class="role-selector" id="roleSelector" style="display: none;">
                <label for="userRole">üë§ Select User Role:</label>
                <select id="userRole" onchange="loadFieldConfiguration()">
                    <option value="">Select a role...</option>
                    <option value="CENTRAL_WORKER">CENTRAL_WORKER</option>
                    <optgroup label="District Workers">
                        <option value="DISTRICT_WORKER">DISTRICT_WORKER</option>
                        <option value="DISTRICT_WORKER_NORTH">DISTRICT_WORKER_NORTH</option>
                        <option value="DISTRICT_WORKER_CENTRAL">DISTRICT_WORKER_CENTRAL</option>
                        <option value="DISTRICT_WORKER_SOUTH">DISTRICT_WORKER_SOUTH</option>
                    </optgroup>
                    <optgroup label="County Workers">
                        <option value="COUNTY_WORKER">COUNTY_WORKER</option>
                        <option value="COUNTY_WORKER_NORTH">COUNTY_WORKER_NORTH</option>
                        <option value="COUNTY_WORKER_CENTRAL">COUNTY_WORKER_CENTRAL</option>
                        <option value="COUNTY_WORKER_SOUTH">COUNTY_WORKER_SOUTH</option>
                    </optgroup>
                    <option value="PROVIDER">PROVIDER</option>
                    <option value="RECIPIENT">RECIPIENT</option>
                </select>
            </div>


            <!-- Field Selection Section -->
            <div class="field-selection-section" id="fieldSelectionSection" style="display: none;">
                <h2 class="section-title">üîß Field Selection</h2>
                <p><strong>Choose which fields this role can see and configure:</strong></p>
                <p class="field-selection-help">Select the fields you want to include in the masking configuration. Only selected fields will appear in the configuration section below.</p>
                <div class="field-selection-controls">
                    <button onclick="selectAllFields()" class="btn btn-secondary">‚úÖ Select All</button>
                    <button onclick="deselectAllFields()" class="btn btn-secondary">‚ùå Deselect All</button>
                    <button onclick="selectCommonFields()" class="btn btn-secondary">‚≠ê Common Fields</button>
                </div>
                <div class="field-selection-grid" id="fieldSelectionGrid">
                    <!-- Field selection checkboxes will be populated here -->
                </div>
            </div>

            <!-- Role Action Configuration Section -->
            <div class="action-config-section" id="actionConfigSection" style="display: none;">
                <h2 class="section-title">‚öôÔ∏è Role Action Configuration</h2>
                <p><strong>Configure what actions this role can perform on the system:</strong></p>
                
                <div class="action-categories">
                    <div class="action-category">
                        <h3>üìä Data Access Actions</h3>
                        <div class="action-grid">
                            <div class="action-item">
                                <label>
                                    <input type="checkbox" id="action_view_reports" onchange="updateActionConfig('view_reports', this.checked)">
                                    <span class="action-name">View Reports</span>
                                    <span class="action-description">Access to view generated reports</span>
                                </label>
                            </div>
                            <div class="action-item">
                                <label>
                                    <input type="checkbox" id="action_export_data" onchange="updateActionConfig('export_data', this.checked)">
                                    <span class="action-name">Export Data</span>
                                    <span class="action-description">Export data in various formats (CSV, JSON, XML)</span>
                                </label>
                            </div>
                            <div class="action-item">
                                <label>
                                    <input type="checkbox" id="action_view_analytics" onchange="updateActionConfig('view_analytics', this.checked)">
                                    <span class="action-name">View Analytics</span>
                                    <span class="action-description">Access to analytics dashboards and insights</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="action-category">
                        <h3>üîß Configuration Actions</h3>
                        <div class="action-grid">
                            <div class="action-item">
                                <label>
                                    <input type="checkbox" id="action_configure_masking" onchange="updateActionConfig('configure_masking', this.checked)">
                                    <span class="action-name">Configure Field Masking</span>
                                    <span class="action-description">Modify field masking rules and visibility settings</span>
                                </label>
                            </div>
                            <div class="action-item">
                                <label>
                                    <input type="checkbox" id="action_manage_users" onchange="updateActionConfig('manage_users', this.checked)">
                                    <span class="action-name">Manage Users</span>
                                    <span class="action-description">Add, edit, or remove user accounts</span>
                                </label>
                            </div>
                            <div class="action-item">
                                <label>
                                    <input type="checkbox" id="action_configure_roles" onchange="updateActionConfig('configure_roles', this.checked)">
                                    <span class="action-name">Configure Roles</span>
                                    <span class="action-description">Modify role permissions and access levels</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="action-category">
                        <h3>üìã Data Processing Actions</h3>
                        <div class="action-grid">
                            <div class="action-item">
                                <label>
                                    <input type="checkbox" id="action_create_reports" onchange="updateActionConfig('create_reports', this.checked)">
                                    <span class="action-name">Create Reports</span>
                                    <span class="action-description">Generate new reports and data extracts</span>
                                </label>
                            </div>
                            <div class="action-item">
                                <label>
                                    <input type="checkbox" id="action_schedule_jobs" onchange="updateActionConfig('schedule_jobs', this.checked)">
                                    <span class="action-name">Schedule Jobs</span>
                                    <span class="action-description">Schedule automated data processing jobs</span>
                                </label>
                            </div>
                            <div class="action-item">
                                <label>
                                    <input type="checkbox" id="action_approve_data" onchange="updateActionConfig('approve_data', this.checked)">
                                    <span class="action-name">Approve Data</span>
                                    <span class="action-description">Approve or reject data submissions</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="action-category">
                        <h3>üîê Security Actions</h3>
                        <div class="action-grid">
                            <div class="action-item">
                                <label>
                                    <input type="checkbox" id="action_audit_logs" onchange="updateActionConfig('audit_logs', this.checked)">
                                    <span class="action-name">View Audit Logs</span>
                                    <span class="action-description">Access system audit logs and activity history</span>
                                </label>
                            </div>
                            <div class="action-item">
                                <label>
                                    <input type="checkbox" id="action_security_settings" onchange="updateActionConfig('security_settings', this.checked)">
                                    <span class="action-name">Security Settings</span>
                                    <span class="action-description">Modify security policies and access controls</span>
                                </label>
                            </div>
                            <div class="action-item">
                                <label>
                                    <input type="checkbox" id="action_emergency_access" onchange="updateActionConfig('emergency_access', this.checked)">
                                    <span class="action-name">Emergency Access</span>
                                    <span class="action-description">Override restrictions in emergency situations</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="action-summary">
                    <h3>üìã Action Summary</h3>
                    <div class="summary-stats">
                        <div class="stat-item">
                            <span class="stat-label">Total Actions:</span>
                            <span class="stat-value" id="totalActions">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Enabled Actions:</span>
                            <span class="stat-value" id="enabledActions">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Disabled Actions:</span>
                            <span class="stat-value" id="disabledActions">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="fields-section">
                <h2 class="section-title">üìä Configure Field Visibility & Masking</h2>
                <div class="fields-grid" id="fieldsGrid">
                    <!-- Fields will be loaded here -->
                </div>
            </div>

            <div class="actions">
                <button class="btn btn-primary" onclick="saveConfiguration()">üíæ Save Configuration</button>
                <button class="btn btn-secondary" onclick="resetConfiguration()">üîÑ Reset to Default</button>
                <button class="btn btn-success" onclick="testConfiguration()">üß™ Test Configuration</button>
                <button class="btn btn-info" onclick="compareRoles()">üîç Compare Roles</button>
                <button class="btn btn-warning" onclick="exportConfiguration()">üì§ Export Config</button>
                <button class="btn btn-dark" onclick="importConfiguration()">üì• Import Config</button>
            </div>
        </div>
    </div>

    <script>
        let currentConfiguration = {};
        let availableFields = [];
        let currentUser = null;
        let accessToken = null;

        // Keycloak Configuration
        const KEYCLOAK_CONFIG = {
            url: 'http://localhost:8085',
            realm: 'cmips',
            clientId: 'cmips-frontend'
        };

        // Authentication Functions
        async function loginUser() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showStatus('Please enter both username and password.', 'error');
                return;
            }

            try {
                showStatus('Logging in...', 'info');
                
                // Call backend authentication endpoint
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });

                if (response.ok) {
                    const authData = await response.json();
                    console.log('Auth response:', authData);
                    
                    currentUser = authData.user;
                    accessToken = authData.accessToken;
                    
                    if (!currentUser) {
                        showStatus('Login failed: No user data received', 'error');
                        return;
                    }
                    
                    if (!accessToken) {
                        showStatus('Login failed: No access token received', 'error');
                        return;
                    }
                    
                    // Show user info and hide login form
                    showUserInfo();
                    showStatus('Login successful!', 'success');
                } else {
                    const error = await response.json();
                    showStatus('Login failed: ' + error.message, 'error');
                }
            } catch (error) {
                showStatus('Login error: ' + error.message, 'error');
            }
        }

        function showUserInfo() {
            if (!currentUser) {
                showStatus('Error: No user data available', 'error');
                return;
            }
            
            // Debug: Show token status
            console.log('üîç showUserInfo: accessToken status =', accessToken ? 'Present' : 'Missing');
            console.log('üîç showUserInfo: accessToken length =', accessToken ? accessToken.length : 0);
            console.log('üîç showUserInfo: currentUser =', currentUser);
            
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('userInfo').style.display = 'block';
            document.getElementById('roleSelector').style.display = 'block';
            
            // Populate user info with safe fallbacks
            document.getElementById('userDisplayName').textContent = currentUser.name || currentUser.username || currentUser.preferred_username || 'Unknown User';
            document.getElementById('userRoleDisplay').textContent = currentUser.role || 'Unknown';
            document.getElementById('sessionStatus').textContent = 'Active';
            document.getElementById('accessLevel').textContent = getAccessLevel(currentUser.role);
            
            // Set the role selector to user's role
            document.getElementById('userRole').value = currentUser.role || 'USER';
            
            // Load available fields and configuration after successful login
            loadAvailableFields().then(() => {
                loadFieldConfiguration();
                loadActionConfiguration();
            });
        }

        function getAccessLevel(role) {
            const accessLevels = {
                'CENTRAL_WORKER': 'Full Access',
                'DISTRICT_WORKER': 'District Level',
                'COUNTY_WORKER': 'County Level',
                'PROVIDER': 'Provider Level',
                'RECIPIENT': 'Recipient Level'
            };
            return accessLevels[role] || 'Limited Access';
        }

        async function logoutUser() {
            try {
                // Call backend logout endpoint
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    }
                });
            } catch (error) {
                console.log('Logout error:', error);
            }
            
            // Clear session data
            currentUser = null;
            accessToken = null;
            
            // Show login form and hide user info
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('roleSelector').style.display = 'none';
            document.getElementById('fieldSelectionSection').style.display = 'none';
            document.getElementById('fieldsSection').style.display = 'none';
            
            // Clear form
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            
            showStatus('Logged out successfully.', 'info');
        }

        // Token refresh functionality
        async function refreshToken() {
            try {
                console.log('üîÑ refreshToken: Attempting to refresh token...');
                
                // Get stored credentials
                const storedUsername = localStorage.getItem('username');
                const storedPassword = localStorage.getItem('password');
                
                if (!storedUsername || !storedPassword) {
                    console.error('üîÑ refreshToken: No stored credentials found');
                    return false;
                }
                
                // Attempt to login again to get fresh token
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: storedUsername,
                        password: storedPassword
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.access_token) {
                        accessToken = data.access_token;
                        localStorage.setItem('accessToken', accessToken);
                        console.log('üîÑ refreshToken: Token refreshed successfully');
                        return true;
                    }
                }
                
                console.error('üîÑ refreshToken: Failed to refresh token');
                return false;
                
            } catch (error) {
                console.error('üîÑ refreshToken: Error refreshing token:', error);
                return false;
            }
        }

        // Enhanced API calls with authentication
        async function makeAuthenticatedRequest(url, options = {}) {
            console.log('üîç makeAuthenticatedRequest: URL =', url);
            console.log('üîç makeAuthenticatedRequest: accessToken =', accessToken ? 'Present' : 'Missing');
            console.log('üîç makeAuthenticatedRequest: accessToken length =', accessToken ? accessToken.length : 0);
            
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + accessToken
                }
            };
            
            console.log('üîç makeAuthenticatedRequest: Headers =', defaultOptions.headers);
            
            const response = await fetch(url, { ...defaultOptions, ...options });
            
            // Check for 401 Unauthorized (expired token)
            if (response.status === 401) {
                console.warn('üîç makeAuthenticatedRequest: Token expired (401), attempting refresh...');
                
                // Try to refresh the token
                const refreshSuccess = await refreshToken();
                if (refreshSuccess) {
                    console.log('üîç makeAuthenticatedRequest: Token refreshed, retrying request...');
                    // Retry the original request with new token
                    const retryOptions = {
                        ...defaultOptions,
                        headers: {
                            ...defaultOptions.headers,
                            'Authorization': 'Bearer ' + accessToken
                        }
                    };
                    return fetch(url, { ...retryOptions, ...options });
                } else {
                    console.error('üîç makeAuthenticatedRequest: Token refresh failed, redirecting to login');
                    showStatus('Session expired. Please login again.', 'warning');
                    setTimeout(() => {
                        window.location.href = '/react-dashboard.html';
                    }, 2000);
                    throw new Error('Authentication failed - please login again');
                }
            }
            
            return response;
        }

        // Load field configuration when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Don't load fields until user is authenticated
            console.log('Page loaded - waiting for user authentication');
        });

        async function loadAvailableFields() {
            try {
                showLoading(true);
                const response = await makeAuthenticatedRequest('/api/field-masking/available-fields');
                const data = await response.json();
                
                if (data.status === 'SUCCESS') {
                    availableFields = data.fields;
                    console.log('Available fields loaded:', availableFields);
                } else {
                    showStatus('Error loading available fields: ' + data.message, 'error');
                }
            } catch (error) {
                showStatus('Error loading available fields: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Field Selection Functions
        function renderFieldSelection() {
            const fieldSelectionGrid = document.getElementById('fieldSelectionGrid');
            fieldSelectionGrid.innerHTML = '';
            
            console.log('üîß Rendering field selection for', availableFields.length, 'fields');
            
            availableFields.forEach((field, index) => {
                const item = document.createElement('div');
                item.className = 'field-selection-item';
                item.innerHTML = `
                    <input type="checkbox" id="field_${field.name}" name="selectedFields" value="${field.name}" 
                           onchange="updateFieldVisibility()" checked>
                    <label for="field_${field.name}">
                        <strong>${field.displayName}</strong>
                        <small>(${field.name})</small>
                        <br><span class="field-type">${field.type}</span>
                    </label>
                `;
                fieldSelectionGrid.appendChild(item);
            });
            
            console.log('‚úÖ Field selection rendered with', fieldSelectionGrid.children.length, 'items');
        }

        function selectAllFields() {
            const checkboxes = document.querySelectorAll('input[name="selectedFields"]');
            checkboxes.forEach(checkbox => checkbox.checked = true);
            updateFieldVisibility();
        }

        function deselectAllFields() {
            const checkboxes = document.querySelectorAll('input[name="selectedFields"]');
            checkboxes.forEach(checkbox => checkbox.checked = false);
            updateFieldVisibility();
        }

        function selectCommonFields() {
            const commonFields = ['timesheetid', 'providerid', 'providername', 'totalhours', 'totalamount', 'status', 'comments'];
            const checkboxes = document.querySelectorAll('input[name="selectedFields"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = commonFields.includes(checkbox.value);
            });
            updateFieldVisibility();
        }

        function updateFieldVisibility() {
            const selectedFields = Array.from(document.querySelectorAll('input[name="selectedFields"]:checked'))
                .map(checkbox => checkbox.value);
            
            // Update availableFields to only include selected fields
            window.selectedFields = availableFields.filter(field => selectedFields.includes(field.name));
            
            // Re-render field configuration if user role is selected
            const userRole = document.getElementById('userRole').value;
            if (userRole) {
                renderFieldConfiguration();
            }
        }

        async function loadFieldConfiguration() {
            const userRole = document.getElementById('userRole').value;
            if (!userRole) {
                document.getElementById('fieldsGrid').innerHTML = '<p>Please select a user role first.</p>';
                return;
            }

            if (!accessToken) {
                showStatus('Please login first.', 'error');
                return;
            }

            try {
                showLoading(true);
                const response = await makeAuthenticatedRequest(`/api/field-masking/interface/${userRole}`);
                const data = await response.json();
                
                if (data.status === 'SUCCESS') {
                    currentConfiguration = data.interface;
                    availableFields = data.interface.availableFields.fields || [];
                    
                    // Get selected fields from backend or default to all fields
                    const backendSelectedFields = data.interface.selectedFields || [];
                    window.selectedFields = backendSelectedFields.length > 0 ? 
                        availableFields.filter(field => backendSelectedFields.includes(field.name)) : 
                        availableFields;
                    
                    // Show field selection section
                    document.getElementById('fieldSelectionSection').style.display = 'block';
                    
                    // Render field selection first
                    renderFieldSelection();
                    
                    // Set checkboxes based on selected fields
                    if (backendSelectedFields.length > 0) {
                        const checkboxes = document.querySelectorAll('input[name="selectedFields"]');
                        checkboxes.forEach(checkbox => {
                            checkbox.checked = backendSelectedFields.includes(checkbox.value);
                        });
                    }
                    
                    renderFieldConfiguration();
                    
                    // Load action configuration
                    loadActionConfiguration();
                } else {
                    showStatus('Error loading configuration: ' + data.message, 'error');
                }
            } catch (error) {
                showStatus('Error loading configuration: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function renderFieldConfiguration() {
            const fieldsGrid = document.getElementById('fieldsGrid');
            const rules = currentConfiguration.rules || [];
            
            fieldsGrid.innerHTML = '';

            // Show field selection section
            document.getElementById('fieldSelectionSection').style.display = 'block';
            
            // Use selected fields if available, otherwise use all fields
            const fieldsToShow = window.selectedFields || availableFields;
            
            fieldsToShow.forEach(field => {
                const rule = rules.find(r => r.fieldName === field.name) || {
                    fieldName: field.name,
                    maskingType: 'NONE',
                    accessLevel: 'FULL_ACCESS',
                    maskingPattern: '',
                    enabled: true
                };

                const fieldCard = createFieldCard(field, rule);
                fieldsGrid.appendChild(fieldCard);
            });
        }

        function createFieldCard(field, rule) {
            const card = document.createElement('div');
            card.className = 'field-card';
            card.innerHTML = `
                <div class="field-header">
                    <div class="field-name">${field.displayName}</div>
                    <div class="field-type">${field.type}</div>
                </div>
                <div class="field-controls">
                    <div class="control-group">
                        <label>Access Level:</label>
                        <select onchange="updateFieldConfig('${field.name}', 'accessLevel', this.value)">
                            <option value="FULL_ACCESS" ${rule.accessLevel === 'FULL_ACCESS' ? 'selected' : ''}>Full Access</option>
                            <option value="MASKED_ACCESS" ${rule.accessLevel === 'MASKED_ACCESS' ? 'selected' : ''}>Masked Access</option>
                            <option value="HIDDEN_ACCESS" ${rule.accessLevel === 'HIDDEN_ACCESS' ? 'selected' : ''}>Hidden Access</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Masking Type:</label>
                        <select onchange="updateFieldConfig('${field.name}', 'maskingType', this.value)">
                            <option value="NONE" ${rule.maskingType === 'NONE' ? 'selected' : ''}>No Masking</option>
                            <option value="HIDDEN" ${rule.maskingType === 'HIDDEN' ? 'selected' : ''}>Hidden</option>
                            <option value="PARTIAL_MASK" ${rule.maskingType === 'PARTIAL_MASK' ? 'selected' : ''}>Partial Mask</option>
                            <option value="HASH_MASK" ${rule.maskingType === 'HASH_MASK' ? 'selected' : ''}>Hash Mask</option>
                            <option value="ANONYMIZE" ${rule.maskingType === 'ANONYMIZE' ? 'selected' : ''}>Anonymize</option>
                            <option value="AGGREGATE" ${rule.maskingType === 'AGGREGATE' ? 'selected' : ''}>Aggregate</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Masking Pattern:</label>
                        <input type="text" 
                               value="${rule.maskingPattern || ''}" 
                               placeholder="e.g., ***, XXX-XX-####"
                               onchange="updateFieldConfig('${field.name}', 'maskingPattern', this.value)">
                    </div>
                    <div class="control-group">
                        <label>
                            <input type="checkbox" 
                                   ${rule.enabled ? 'checked' : ''} 
                                   onchange="updateFieldConfig('${field.name}', 'enabled', this.checked)">
                            Enable this field
                        </label>
                    </div>
                </div>
            `;
            return card;
        }

        function updateFieldConfig(fieldName, property, value) {
            if (!currentConfiguration.rules) {
                currentConfiguration.rules = [];
            }

            let rule = currentConfiguration.rules.find(r => r.fieldName === fieldName);
            if (!rule) {
                rule = {
                    fieldName: fieldName,
                    maskingType: 'NONE',
                    accessLevel: 'FULL_ACCESS',
                    maskingPattern: '',
                    enabled: true
                };
                currentConfiguration.rules.push(rule);
            }

            rule[property] = value;
            console.log('Updated field config:', fieldName, property, value);
        }

        async function saveConfiguration() {
            const userRole = document.getElementById('userRole').value;
            if (!userRole) {
                showStatus('Please select a user role first.', 'error');
                return;
            }

            console.log('üîç saveConfiguration: userRole =', userRole);
            console.log('üîç saveConfiguration: accessToken =', accessToken ? 'Present' : 'Missing');

            if (!accessToken) {
                showStatus('Please login first.', 'error');
                return;
            }

            try {
                showLoading(true);
                // Get selected fields
                const selectedFields = Array.from(document.querySelectorAll('input[name="selectedFields"]:checked'))
                    .map(checkbox => checkbox.value);
                
                // Create rules for ALL selected fields, not just the ones that were interacted with
                const filteredRules = selectedFields.map(fieldName => {
                    // Find existing rule or create default rule
                    const existingRule = (currentConfiguration.rules || []).find(rule => rule.fieldName === fieldName);
                    return existingRule || {
                        fieldName: fieldName,
                        maskingType: 'NONE',
                        accessLevel: 'FULL_ACCESS',
                        maskingPattern: '',
                        enabled: true
                    };
                });
                
                console.log('üîç saveConfiguration: selectedFields =', selectedFields);
                console.log('üîç saveConfiguration: filteredRules =', filteredRules);
                
                const response = await makeAuthenticatedRequest(`/api/field-masking/update-rules`, {
                    method: 'POST',
                    body: JSON.stringify({
                        userRole: userRole,
                        rules: filteredRules,
                        selectedFields: selectedFields
                    })
                });

                console.log('üîç saveConfiguration: Response status =', response.status);
                console.log('üîç saveConfiguration: Response headers =', response.headers);
                
                const data = await response.json();
                console.log('üîç saveConfiguration: Response data =', data);
                
                if (data.status === 'SUCCESS') {
                    showStatus('Configuration saved successfully!', 'success');
                } else {
                    showStatus('Error saving configuration: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('üîç saveConfiguration: Error =', error);
                showStatus('Error saving configuration: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function resetConfiguration() {
            if (confirm('Are you sure you want to reset to default configuration?')) {
                loadFieldConfiguration();
                showStatus('Configuration reset to default.', 'success');
            }
        }

        async function testConfiguration() {
            const userRole = document.getElementById('userRole').value;
            if (!userRole) {
                showStatus('Please select a user role first.', 'error');
                return;
            }

            try {
                showLoading(true);
                const response = await makeAuthenticatedRequest('/api/field-masking/test-masking', {
                    method: 'POST',
                    body: JSON.stringify({
                        userRole: userRole,
                        testData: {
                            timesheetid: "test-123",
                            providername: "John Doe",
                            provideremail: "john.doe@company.com",
                            totalamount: 5000.0,
                            comments: "This is a test comment"
                        }
                    })
                });

                const data = await response.json();
                
                if (data.status === 'SUCCESS') {
                    showStatus('Test completed successfully! Check console for results.', 'success');
                    console.log('Test results:', data);
                } else {
                    showStatus('Test failed: ' + data.message, 'error');
                }
            } catch (error) {
                showStatus('Test failed: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function compareRoles() {
            // Open role comparison interface in a new tab
            window.open('/role-comparison.html', '_blank');
        }


        function showStatus(message, type) {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.textContent = message;
            statusMessage.className = `status-message status-${type}`;
            statusMessage.style.display = 'block';
            
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 5000);
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // Action Configuration Functions
        let actionConfigurations = {};

        function updateActionConfig(actionName, enabled) {
            const userRole = document.getElementById('userRole').value;
            if (!userRole) return;

            if (!actionConfigurations[userRole]) {
                actionConfigurations[userRole] = {};
            }

            actionConfigurations[userRole][actionName] = enabled;
            updateActionSummary();
            console.log(`Action ${actionName} ${enabled ? 'enabled' : 'disabled'} for role ${userRole}`);
        }

        function updateActionSummary() {
            const userRole = document.getElementById('userRole').value;
            if (!userRole) return;

            const actions = actionConfigurations[userRole] || {};
            const totalActions = 12; // Total number of actions
            const enabledActions = Object.values(actions).filter(enabled => enabled).length;
            const disabledActions = totalActions - enabledActions;

            document.getElementById('totalActions').textContent = totalActions;
            document.getElementById('enabledActions').textContent = enabledActions;
            document.getElementById('disabledActions').textContent = disabledActions;
        }

        function loadActionConfiguration() {
            const userRole = document.getElementById('userRole').value;
            if (!userRole) return;

            // Load default action configurations based on role
            const defaultActions = getDefaultActionsForRole(userRole);
            
            // Apply default configurations
            Object.keys(defaultActions).forEach(actionName => {
                const checkbox = document.getElementById(`action_${actionName}`);
                if (checkbox) {
                    checkbox.checked = defaultActions[actionName];
                    updateActionConfig(actionName, defaultActions[actionName]);
                }
            });

            // Show action configuration section
            document.getElementById('actionConfigSection').style.display = 'block';
        }

        function getDefaultActionsForRole(role) {
            const roleActions = {
                'CENTRAL_WORKER': {
                    view_reports: true,
                    export_data: true,
                    view_analytics: true,
                    configure_masking: true,
                    manage_users: true,
                    configure_roles: true,
                    create_reports: true,
                    schedule_jobs: true,
                    approve_data: true,
                    audit_logs: true,
                    security_settings: true,
                    emergency_access: true
                },
                'DISTRICT_WORKER': {
                    view_reports: true,
                    export_data: true,
                    view_analytics: false,
                    configure_masking: false,
                    manage_users: false,
                    configure_roles: false,
                    create_reports: true,
                    schedule_jobs: false,
                    approve_data: true,
                    audit_logs: false,
                    security_settings: false,
                    emergency_access: false
                },
                'DISTRICT_WORKER_NORTH': {
                    view_reports: true,
                    export_data: true,
                    view_analytics: false,
                    configure_masking: false,
                    manage_users: false,
                    configure_roles: false,
                    create_reports: true,
                    schedule_jobs: false,
                    approve_data: true,
                    audit_logs: false,
                    security_settings: false,
                    emergency_access: false
                },
                'DISTRICT_WORKER_CENTRAL': {
                    view_reports: true,
                    export_data: true,
                    view_analytics: false,
                    configure_masking: false,
                    manage_users: false,
                    configure_roles: false,
                    create_reports: true,
                    schedule_jobs: false,
                    approve_data: true,
                    audit_logs: false,
                    security_settings: false,
                    emergency_access: false
                },
                'DISTRICT_WORKER_SOUTH': {
                    view_reports: true,
                    export_data: true,
                    view_analytics: false,
                    configure_masking: false,
                    manage_users: false,
                    configure_roles: false,
                    create_reports: true,
                    schedule_jobs: false,
                    approve_data: true,
                    audit_logs: false,
                    security_settings: false,
                    emergency_access: false
                },
                'COUNTY_WORKER': {
                    view_reports: true,
                    export_data: false,
                    view_analytics: false,
                    configure_masking: false,
                    manage_users: false,
                    configure_roles: false,
                    create_reports: false,
                    schedule_jobs: false,
                    approve_data: false,
                    audit_logs: false,
                    security_settings: false,
                    emergency_access: false
                },
                'COUNTY_WORKER_NORTH': {
                    view_reports: true,
                    export_data: false,
                    view_analytics: false,
                    configure_masking: false,
                    manage_users: false,
                    configure_roles: false,
                    create_reports: false,
                    schedule_jobs: false,
                    approve_data: false,
                    audit_logs: false,
                    security_settings: false,
                    emergency_access: false
                },
                'COUNTY_WORKER_CENTRAL': {
                    view_reports: true,
                    export_data: false,
                    view_analytics: false,
                    configure_masking: false,
                    manage_users: false,
                    configure_roles: false,
                    create_reports: false,
                    schedule_jobs: false,
                    approve_data: false,
                    audit_logs: false,
                    security_settings: false,
                    emergency_access: false
                },
                'COUNTY_WORKER_SOUTH': {
                    view_reports: true,
                    export_data: false,
                    view_analytics: false,
                    configure_masking: false,
                    manage_users: false,
                    configure_roles: false,
                    create_reports: false,
                    schedule_jobs: false,
                    approve_data: false,
                    audit_logs: false,
                    security_settings: false,
                    emergency_access: false
                },
                'PROVIDER': {
                    view_reports: true,
                    export_data: false,
                    view_analytics: false,
                    configure_masking: false,
                    manage_users: false,
                    configure_roles: false,
                    create_reports: false,
                    schedule_jobs: false,
                    approve_data: false,
                    audit_logs: false,
                    security_settings: false,
                    emergency_access: false
                },
                'RECIPIENT': {
                    view_reports: true,
                    export_data: false,
                    view_analytics: false,
                    configure_masking: false,
                    manage_users: false,
                    configure_roles: false,
                    create_reports: false,
                    schedule_jobs: false,
                    approve_data: false,
                    audit_logs: false,
                    security_settings: false,
                    emergency_access: false
                }
            };

            // If role not found, try to match by prefix (e.g., DISTRICT_WORKER_NORTH -> DISTRICT_WORKER)
            if (!roleActions[role]) {
                if (role.startsWith('DISTRICT_WORKER_')) {
                    return roleActions['DISTRICT_WORKER'] || {};
                } else if (role.startsWith('COUNTY_WORKER_')) {
                    return roleActions['COUNTY_WORKER'] || {};
                }
            }

            return roleActions[role] || {};
        }

        function exportConfiguration() {
            const userRole = document.getElementById('userRole').value;
            if (!userRole) {
                showStatus('Please select a user role first.', 'error');
                return;
            }

            const configuration = {
                role: userRole,
                fieldMasking: currentConfiguration,
                actionConfig: actionConfigurations[userRole] || {},
                exportDate: new Date().toISOString(),
                version: '1.0'
            };

            const dataStr = JSON.stringify(configuration, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `field-masking-config-${userRole}-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);

            showStatus('Configuration exported successfully!', 'success');
        }

        function importConfiguration() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const config = JSON.parse(e.target.result);
                            if (config.role && config.fieldMasking) {
                                // Apply imported configuration
                                currentConfiguration = config.fieldMasking;
                                if (config.actionConfig) {
                                    actionConfigurations[config.role] = config.actionConfig;
                                }
                                loadFieldConfiguration();
                                loadActionConfiguration();
                                showStatus('Configuration imported successfully!', 'success');
                            } else {
                                showStatus('Invalid configuration file format.', 'error');
                            }
                        } catch (error) {
                            showStatus('Error parsing configuration file: ' + error.message, 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

    </script>
</body>
</html>
