server:
  port: 8080

spring:
  application:
    name: timesheet-reporting-app
  web:
    resources:
      add-mappings: true
      static-locations: classpath:/static/
  jackson:
    time-zone: Asia/Kolkata
    date-format: yyyy-MM-dd'T'HH:mm:ss
  
  # Database Configuration (PostgreSQL) with AWS Secrets Manager
  datasource:
    use-secrets-manager: ${USE_SECRETS_MANAGER:true}
    url: jdbc:postgresql://${DB_HOST:database-1.cqn2wg0syn5v.us-east-1.rds.amazonaws.com}:${DB_PORT:5432}/${DB_NAME:ihsscmips}?useSSL=false&serverTimezone=UTC
    username: ${SPRING_DATASOURCE_USERNAME:cmips_app}
    password: ${SPRING_DATASOURCE_PASSWORD:cmips_app_password}
    driver-class-name: org.postgresql.Driver
    hikari:
      maximum-pool-size: 10
      minimum-idle: 2
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
  
  # JPA Configuration
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: true
  
  
  # Spring Security Configuration
  security:
    oauth2:
      resourceserver:
        jwt:
          # Use sajeevs-codebase-main Keycloak instance
          issuer-uri: ${KEYCLOAK_ISSUER_URI:http://cmips-keycloak:8080/realms/cmips}

# Management and Monitoring Configuration
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,env
  endpoint:
    health:
      show-details: always
      show-components: always
  health:
    db:
      enabled: true

# Logging Configuration
logging:
  level:
    com.example.kafkaeventdrivenapp: DEBUG
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE

# SFTP Configuration (Mock Server for Testing)
sftp:
  host: ${SFTP_HOST:localhost}
  port: ${SFTP_PORT:22}
  username: ${SFTP_USERNAME:reports}
  password: ${SFTP_PASSWORD:password}
  base-path: ${SFTP_BASE_PATH:/reports}
  private-key-path: ${SFTP_PRIVATE_KEY_PATH:}
  private-key-passphrase: ${SFTP_PRIVATE_KEY_PASSPHRASE:}

# Encryption Configuration
encryption:
  algorithm: ${ENCRYPTION_ALGORITHM:AES}
  key-size: ${ENCRYPTION_KEY_SIZE:256}
  key-file: ${ENCRYPTION_KEY_FILE:encryption.key}

# Notification Configuration
notification:
  email:
    enabled: ${NOTIFICATION_EMAIL_ENABLED:true}
    smtp:
      host: ${NOTIFICATION_EMAIL_SMTP_HOST:localhost}
      port: ${NOTIFICATION_EMAIL_SMTP_PORT:587}
    from: ${NOTIFICATION_EMAIL_FROM:reports@system.com}
    to: ${NOTIFICATION_EMAIL_TO:admin@system.com}
  sms:
    enabled: ${NOTIFICATION_SMS_ENABLED:false}
  webhook:
    enabled: ${NOTIFICATION_WEBHOOK_ENABLED:true}
    url: ${NOTIFICATION_WEBHOOK_URL:http://localhost:8080/api/notifications}
  service-url: ${NOTIFICATION_SERVICE_URL:}

external-validation:
  url: ${EXTERNAL_VALIDATION_URL:}

# Email Configuration
mail:
  host: ${MAIL_HOST:}
  port: ${MAIL_PORT:}
  username: ${MAIL_USERNAME:}
  password: ${MAIL_PASSWORD:}
  properties:
    mail:
      smtp:
        auth: true
        starttls:
          enable: true

# Report Types Configuration - Centralized definition of all report types
report-types:
  # All valid report types in the system
  all:
    - COUNTY_DAILY
    - DAILY_SUMMARY
    - WEEKLY_REPORT
    - MONTHLY_REPORT
    - QUARTERLY_REPORT
    - ANNUAL_REPORT
    - TIMESHEET_REPORT
    - CONSOLIDATED_REPORT
    - COUNTY_ANALYTICS
    - PAYROLL_REPORT
    - PROJECT_REPORT
    - PROVIDER_REPORT
    - HR_REPORT
    - SUMMARY_REPORT
    - DETAILED_REPORT
    - GENERIC_REPORT
  
  # Role-specific report type mappings
  role-mappings:
    ADMIN:
      - COUNTY_DAILY
      - DAILY_SUMMARY
      - WEEKLY_REPORT
      - MONTHLY_REPORT
      - QUARTERLY_REPORT
      - ANNUAL_REPORT
      - CONSOLIDATED_REPORT
    SUPERVISOR:
      - COUNTY_DAILY
      - DAILY_SUMMARY
      - TIMESHEET_REPORT
      - COUNTY_ANALYTICS
    CASE_WORKER:
      - COUNTY_DAILY
      - DAILY_SUMMARY
      - TIMESHEET_REPORT
  
  # Scheduler-specific configurations
  schedulers:
    daily:
      - COUNTY_DAILY
      - DAILY_SUMMARY
    weekly:
      - WEEKLY_REPORT
    monthly:
      - MONTHLY_REPORT
    quarterly:
      - QUARTERLY_REPORT
    annual:
      - ANNUAL_REPORT
    test:
      - COUNTY_DAILY  # Fixed from DAILY_REPORT to COUNTY_DAILY
  
  # Default report type for various contexts
  default-report-type: TIMESHEET_REPORT
  
  # Report processing estimated durations (in minutes)
  estimated-durations:
    COUNTY_DAILY: 2
    DAILY_SUMMARY: 3
    WEEKLY_REPORT: 10
    MONTHLY_REPORT: 30
    QUARTERLY_REPORT: 60
    ANNUAL_REPORT: 120
    TIMESHEET_REPORT: 5
    CONSOLIDATED_REPORT: 15
    COUNTY_ANALYTICS: 20
    PAYROLL_REPORT: 8
    PROJECT_REPORT: 7
    PROVIDER_REPORT: 6
    HR_REPORT: 10
    SUMMARY_REPORT: 4
    DETAILED_REPORT: 8
    GENERIC_REPORT: 5

# Report Configuration
report:
  scheduling:
    enabled: true
    daily-report-cron: "0 30 5 * * ?"     # 11:00 AM IST (05:30 UTC) daily
    weekly-report-cron: "0 30 5 * * MON"     # 11:00 AM IST (05:30 UTC) every Monday
    monthly-report-cron: "0 30 5 1 * ?"      # 11:00 AM IST (05:30 UTC) on the 1st of each month
    quarterly-report-cron: "0 30 5 1 1,4,7,10 ?"  # 11:00 AM IST (05:30 UTC) on quarter start months
    yearly-report-cron: "0 30 5 1 1 ?"  # 11:00 AM IST (05:30 UTC) on January 1st
  scheduler:
    system-scheduler:
      enabled: ${REPORT_SCHEDULER_ENABLED:true}
      cron: ${REPORT_SCHEDULER_CRON:0 */2 * * * ?}  # Every 2 minutes (for testing - will trigger 5 times in next 10 minutes)
      report-types: ["COUNTY_DAILY", "DAILY_SUMMARY"]
      storage-path: ${REPORT_STORAGE_PATH:./reports}
      timezone: ${REPORT_SCHEDULER_TIMEZONE:Asia/Kolkata}
  email:
    enabled: true
    from: reports@system.com
    default-recipients:
      - admin@system.com
    subject-prefix: "[Report System]"
  pdf:
    page-size: A4
    font-size: 10
    include-logo: false
  sftp:
    enabled: true

# Job Dependencies Configuration
job-dependencies:
  enabled: true
  dependencies:
    # FIXED: Simple one-to-one dependency
    # When COUNTY_DAILY completes successfully, automatically trigger DAILY_SUMMARY
    - parent-report-type: "COUNTY_DAILY"
      parent-role: "CASE_WORKER"  # Trigger only for case workers
      dependent-report-type: "DAILY_SUMMARY"
      dependent-role: "CASE_WORKER"  # Keep dependent job scoped to case worker
      dependent-target-system: "SCHEDULED"
      dependent-data-format: "JSON"
      condition: "ON_SUCCESS"  # ON_SUCCESS (only if parent succeeded) or ON_COMPLETION (always)
    
    # Multiple dependencies (Job C depends on both A and B)
    # When BOTH WEEKLY_REPORT and MONTHLY_REPORT complete successfully, trigger CONSOLIDATED_REPORT
    - parent-report-types: ["WEEKLY_REPORT", "MONTHLY_REPORT"]  # ALL must succeed
      dependent-report-type: "CONSOLIDATED_REPORT"
      dependent-role: "ADMIN"
      condition: "ON_SUCCESS"
    
    # Role-specific dependency
    # When COUNTY_DAILY for CASE_WORKER completes, trigger COUNTY_ANALYTICS
    - parent-report-type: "COUNTY_DAILY"
      parent-role: "CASE_WORKER"  # Only trigger for specific role
      dependent-report-type: "COUNTY_ANALYTICS"
      dependent-role: "ADMIN"
      condition: "ON_SUCCESS"

job-processing:
  default-chunk-size: 1000
  dependent-chunk-size: 2000
  min-chunk-size: 50
  max-chunk-size: 5000

batch:
  scheduler:
    enabled: true
    interval-ms: 5000
    max-jobs-per-poll: 3
    worker-pool-size: 2
  test-scheduler:
    enabled: false
    interval-ms: 120000  # 2 minutes (120000ms) - triggers jobs every 2 minutes for 10 minutes (5 jobs total) - DISABLED

# AWS Configuration
aws:
  region: ${AWS_REGION:us-east-1}
  secrets-manager:
    secret-name: ${AWS_SECRETS_MANAGER_SECRET_NAME:rds!db-1feddbab-53e9-444c-a6bc-cf17b014e58d}

# Keycloak Configuration
# Using sajeevs-codebase-main Keycloak instance for authentication
keycloak:
  auth-server-url: ${KEYCLOAK_AUTH_SERVER_URL:http://cmips-keycloak:8080}
  realm: ${KEYCLOAK_REALM:cmips}
  client-uuid: ${KEYCLOAK_CLIENT_UUID:fd72c4fc-3685-42fa-b8ec-859f1a4a51df}
  admin-user: ${KEYCLOAK_ADMIN_USER:admin}
  admin-password: ${KEYCLOAK_ADMIN_PASSWORD:admin123}
  
  # Service account for scheduled reports (using cmips-frontend client)
  service-account:
    client-id: ${KEYCLOAK_SERVICE_CLIENT_ID:trial-app}
    client-secret: ${KEYCLOAK_SERVICE_CLIENT_SECRET:UnpJullDQX23tenZ4IsTuGkY8QzBlcFd}
    enabled: true
    token-refresh-threshold: 300 # Refresh token 5 minutes before expiry
  resource: ${KEYCLOAK_CLIENT_ID:trial-app}
  credentials:
    secret: ${KEYCLOAK_CLIENT_SECRET:UnpJullDQX23tenZ4IsTuGkY8QzBlcFd}
  public-client: false
  ssl-required: external
  verify-token-audience: true
  use-resource-role-mappings: true
  
  # Role-specific token exchange for scheduled batch jobs
  role-token:
    exchange-enabled: true
    admin-subject-id: ${KEYCLOAK_ROLE_ADMIN_SUBJECT_ID:}
    supervisor-subject-id: ${KEYCLOAK_ROLE_SUPERVISOR_SUBJECT_ID:}
    case-worker-subject-id: ${KEYCLOAK_ROLE_CASE_WORKER_SUBJECT_ID:}
    provider-subject-id: ${KEYCLOAK_ROLE_PROVIDER_SUBJECT_ID:}
    recipient-subject-id: ${KEYCLOAK_ROLE_RECIPIENT_SUBJECT_ID:}
    credentials:
      admin:
        username: ${KEYCLOAK_ROLE_ADMIN_USERNAME:cron_admin}
        password: ${KEYCLOAK_ROLE_ADMIN_PASSWORD:cron_admin_pass_123!}
      supervisor:
        username: ${KEYCLOAK_ROLE_SUPERVISOR_USERNAME:cron_supervisor}
        password: ${KEYCLOAK_ROLE_SUPERVISOR_PASSWORD:cron_supervisor_pass_123!}
      case-worker:
        username: ${KEYCLOAK_ROLE_CASE_WORKER_USERNAME:cron_case_worker}
        password: ${KEYCLOAK_ROLE_CASE_WORKER_PASSWORD:cron_case_worker_pass_123!}
      provider:
        username: ${KEYCLOAK_ROLE_PROVIDER_USERNAME:cron_provider}
        password: ${KEYCLOAK_ROLE_PROVIDER_PASSWORD:cron_provider_pass_123!}
      recipient:
        username: ${KEYCLOAK_ROLE_RECIPIENT_USERNAME:cron_recipient}
        password: ${KEYCLOAK_ROLE_RECIPIENT_PASSWORD:cron_recipient_pass_123!}
      system-scheduler:
        username: ${KEYCLOAK_SYSTEM_SCHEDULER_USERNAME:system_scheduler}
        password: ${KEYCLOAK_SYSTEM_SCHEDULER_PASSWORD:system_scheduler_pass_123!}

# --- ENV DOCUMENTATION (for VPC deployment) ---
# (infra node)  172.31.29.103 / ip-172-31-29-103.ec2.internal
# (app node)    172.31.56.80  / ip-172-31-56-80.ec2.internal
#
# Example for app infra deployment:
# KEYCLOAK_AUTH_SERVER_URL=http://ip-172-31-29-103.ec2.internal:8085
# KEYCLOAK_ISSUER_URI=http://ip-172-31-29-103.ec2.internal:8085/realms/cmips
# EXTERNAL_VALIDATION_URL=http://ip-172-31-56-80.ec2.internal:8082/api/validation/validate
# NOTIFICATION_SERVICE_URL=http://ip-172-31-56-80.ec2.internal:8081/notify
# MAIL_HOST=ip-172-31-29-103.ec2.internal
# SFTP_HOST=ip-172-31-29-103.ec2.internal
# (All other credentials in AWS Secrets Manager)
